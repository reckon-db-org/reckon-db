<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.38.2">
    <meta name="project" content="reckon_db v1.1.0">


    <title>Schema Evolution — reckon_db v1.1.0</title>

    <link rel="stylesheet" href="dist/html-erlang-DQDXQC7W.css" />

    <script defer src="dist/sidebar_items-C13C6AD1.js"></script>
    <script defer src="docs_config.js"></script>
    <script defer src="dist/html-DPJLHKSM.js"></script>

  </head>
  <body>
    <script>(()=>{var t="ex_doc:settings",e="dark";var o="dark",s="light";var E="sidebar_state",n="closed";var r="sidebar_width";var a="sidebar-open";var i=new URLSearchParams(window.location.search),S=i.get("theme")||JSON.parse(localStorage.getItem(t)||"{}").theme;(S===o||S!==s&&window.matchMedia("(prefers-color-scheme: dark)").matches)&&document.body.classList.add(e);var d=sessionStorage.getItem(E),A=d!==n&&!window.matchMedia(`screen and (max-width: ${768}px)`).matches;document.body.classList.toggle(a,A);var c=sessionStorage.getItem(r);c&&document.body.style.setProperty("--sidebarWidth",`${c}px`);var p=/(Macintosh|iPhone|iPad|iPod)/.test(window.navigator.userAgent);document.documentElement.classList.toggle("apple-os",p);})();
</script>

<div class="body-wrapper">

<button id="sidebar-menu" class="sidebar-button sidebar-toggle" aria-label="toggle sidebar" aria-controls="sidebar">
  <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
</button>

<nav id="sidebar" class="sidebar">

  <div class="sidebar-header">
    <div class="sidebar-projectInfo">

      <div>
        <a href="readme.html" class="sidebar-projectName" translate="no">
reckon_db
        </a>
        <div class="sidebar-projectVersion" translate="no">
          v1.1.0
        </div>
      </div>
    </div>
    <ul id="sidebar-list-nav" class="sidebar-list-nav" role="tablist" data-extras=""></ul>
  </div>
</nav>

<output role="status" id="toast"></output>

<main class="content page-extra" id="main" data-type="extras">
  <div id="content" class="content-inner">
    <div class="top-search">
      <div class="search-settings">
        <form class="search-bar" action="search.html">
          <label class="search-label">
            <span class="sr-only">Search documentation of reckon_db</span>
            <input name="q" type="text" class="search-input" placeholder="Press / to search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
          </label>
          <button type="submit" class="search-button" aria-label="Submit Search" tabindex="-1">
            <i class="ri-search-2-line ri-lg" aria-hidden="true"></i>
          </button>
          <button type="button" tabindex="-1" class="search-close-button" aria-hidden="true">
            <i class="ri-close-line ri-lg" title="Cancel search"></i>
          </button>
        </form>
        <div class="autocomplete">
        </div>
        <button class="icon-settings display-settings">
          <i class="ri-settings-3-line"></i>
          <span class="sr-only">Settings</span>
        </button>
      </div>
    </div>

<div id="top-content">
  <div class="heading-with-actions top-heading">
    <h1>Schema Evolution and Upcasting</h1>


      <a href="https://github.com/reckon-db-org/reckon-db/blob/v1.1.0/guides/schema_evolution.md#L1" title="View Source" class="icon-action" rel="help">
        <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        <span class="sr-only">View Source</span>
      </a>

  </div>


<p>Schema evolution enables changing event structures over time without breaking existing consumers. This guide covers schema registration, version management, and automatic upcasting.</p><h2 id="overview" class="section-heading"><a href="#overview" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Overview</span></h2><p>The <code class="inline">reckon_db_schema</code> module provides:</p><table><thead><tr><th style="text-align: left;">Function</th><th style="text-align: left;">Purpose</th></tr></thead><tbody><tr><td style="text-align: left;"><code class="inline">register/3</code></td><td style="text-align: left;">Register a schema for an event type</td></tr><tr><td style="text-align: left;"><code class="inline">unregister/2</code></td><td style="text-align: left;">Remove a schema</td></tr><tr><td style="text-align: left;"><code class="inline">get/2</code></td><td style="text-align: left;">Get schema for an event type</td></tr><tr><td style="text-align: left;"><code class="inline">list/1</code></td><td style="text-align: left;">List all registered schemas</td></tr><tr><td style="text-align: left;"><code class="inline">get_version/2</code></td><td style="text-align: left;">Get current schema version</td></tr><tr><td style="text-align: left;"><code class="inline">upcast/2</code></td><td style="text-align: left;">Upcast a list of events</td></tr><tr><td style="text-align: left;"><code class="inline">upcast_event/2</code></td><td style="text-align: left;">Upcast a single event</td></tr><tr><td style="text-align: left;"><code class="inline">validate/2</code></td><td style="text-align: left;">Validate event against schema</td></tr></tbody></table><h2 id="architecture" class="section-heading"><a href="#architecture" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Architecture</span></h2><p><img src="../assets/schema_upcasting.svg" alt="Schema Upcasting Flow"/></p><h2 id="schema-registration" class="section-heading"><a href="#schema-registration" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Schema Registration</span></h2><h3 id="basic-registration" class="section-heading"><a href="#basic-registration" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Basic Registration</span></h3><pre><code class="makeup erlang" translate="no"><span class="ss">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">reckon_db_schema</span><span class="p">:</span><span class="nf">register</span><span class="p" data-group-id="3736070363-1">(</span><span class="ss">my_store</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="3736070363-2">&lt;&lt;</span><span class="s">&quot;OrderPlaced&quot;</span><span class="p" data-group-id="3736070363-2">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="3736070363-3">#{</span><span class="w">
    </span><span class="ss">version</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
    </span><span class="ss">description</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="3736070363-4">&lt;&lt;</span><span class="s">&quot;Initial order event schema&quot;</span><span class="p" data-group-id="3736070363-4">&gt;&gt;</span><span class="w">
</span><span class="p" data-group-id="3736070363-3">}</span><span class="p" data-group-id="3736070363-1">)</span><span class="p">.</span></code></pre><h3 id="registration-with-upcasting" class="section-heading"><a href="#registration-with-upcasting" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Registration with Upcasting</span></h3><pre><code class="makeup erlang" translate="no"><span class="ss">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">reckon_db_schema</span><span class="p">:</span><span class="nf">register</span><span class="p" data-group-id="7683950942-1">(</span><span class="ss">my_store</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7683950942-2">&lt;&lt;</span><span class="s">&quot;OrderPlaced&quot;</span><span class="p" data-group-id="7683950942-2">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7683950942-3">#{</span><span class="w">
    </span><span class="ss">version</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w">
    </span><span class="ss">upcast_from</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="7683950942-4">#{</span><span class="w">
        </span><span class="mi">1</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="7683950942-5">(</span><span class="n">Data</span><span class="p" data-group-id="7683950942-5">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="c1">%% V1 -&gt; V2: Add shipping_address field</span><span class="w">
            </span><span class="nc">maps</span><span class="p">:</span><span class="nf">put</span><span class="p" data-group-id="7683950942-6">(</span><span class="ss">shipping_address</span><span class="p">,</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="7683950942-7">(</span><span class="ss">address</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7683950942-8">#{</span><span class="p" data-group-id="7683950942-8">}</span><span class="p" data-group-id="7683950942-7">)</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="7683950942-6">)</span><span class="w">
        </span><span class="k">end</span><span class="p">,</span><span class="w">
        </span><span class="mi">2</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="7683950942-9">(</span><span class="n">Data</span><span class="p" data-group-id="7683950942-9">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="c1">%% V2 -&gt; V3: Rename customer_id to buyer_id</span><span class="w">
            </span><span class="n">BuyerId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="7683950942-10">(</span><span class="ss">customer_id</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="7683950942-10">)</span><span class="p">,</span><span class="w">
            </span><span class="nc">maps</span><span class="p">:</span><span class="nf">remove</span><span class="p" data-group-id="7683950942-11">(</span><span class="ss">customer_id</span><span class="p">,</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">put</span><span class="p" data-group-id="7683950942-12">(</span><span class="ss">buyer_id</span><span class="p">,</span><span class="w"> </span><span class="n">BuyerId</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="7683950942-12">)</span><span class="p" data-group-id="7683950942-11">)</span><span class="w">
        </span><span class="k">end</span><span class="w">
    </span><span class="p" data-group-id="7683950942-4">}</span><span class="w">
</span><span class="p" data-group-id="7683950942-3">}</span><span class="p" data-group-id="7683950942-1">)</span><span class="p">.</span></code></pre><h3 id="registration-with-validation" class="section-heading"><a href="#registration-with-validation" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Registration with Validation</span></h3><pre><code class="makeup erlang" translate="no"><span class="ss">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">reckon_db_schema</span><span class="p">:</span><span class="nf">register</span><span class="p" data-group-id="6977626637-1">(</span><span class="ss">my_store</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6977626637-2">&lt;&lt;</span><span class="s">&quot;PaymentReceived&quot;</span><span class="p" data-group-id="6977626637-2">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6977626637-3">#{</span><span class="w">
    </span><span class="ss">version</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
    </span><span class="ss">validator</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="6977626637-4">(</span><span class="n">Data</span><span class="p" data-group-id="6977626637-4">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="k">case</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">is_key</span><span class="p" data-group-id="6977626637-5">(</span><span class="ss">amount</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="6977626637-5">)</span><span class="w"> </span><span class="ow">andalso</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">is_key</span><span class="p" data-group-id="6977626637-6">(</span><span class="ss">currency</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="6977626637-6">)</span><span class="w"> </span><span class="k">of</span><span class="w">
            </span><span class="ss">true</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="ss">ok</span><span class="p">;</span><span class="w">
            </span><span class="ss">false</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p" data-group-id="6977626637-7">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">missing_required_fields</span><span class="p" data-group-id="6977626637-7">}</span><span class="w">
        </span><span class="k">end</span><span class="w">
    </span><span class="k">end</span><span class="w">
</span><span class="p" data-group-id="6977626637-3">}</span><span class="p" data-group-id="6977626637-1">)</span><span class="p">.</span></code></pre><h2 id="schema-storage" class="section-heading"><a href="#schema-storage" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Schema Storage</span></h2><p>Schemas are stored in Khepri at:</p><pre><code class="makeup erlang" translate="no"><span class="p" data-group-id="9951660122-1">[</span><span class="ss">schemas</span><span class="p">,</span><span class="w"> </span><span class="n">StoreId</span><span class="p">,</span><span class="w"> </span><span class="n">EventType</span><span class="p" data-group-id="9951660122-1">]</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nf">schema_map</span><span class="p" data-group-id="9951660122-2">(</span><span class="p" data-group-id="9951660122-2">)</span></code></pre><h3 id="schema-structure" class="section-heading"><a href="#schema-structure" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Schema Structure</span></h3><pre><code class="makeup erlang" translate="no"><span class="p">-</span><span class="na">type</span><span class="w"> </span><span class="nf">schema</span><span class="p" data-group-id="0973520181-1">(</span><span class="p" data-group-id="0973520181-1">)</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="0973520181-2">#{</span><span class="w">
    </span><span class="ss">event_type</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="nf">binary</span><span class="p" data-group-id="0973520181-3">(</span><span class="p" data-group-id="0973520181-3">)</span><span class="p">,</span><span class="w">       </span><span class="c1">%% Event type name</span><span class="w">
    </span><span class="ss">version</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="nf">pos_integer</span><span class="p" data-group-id="0973520181-4">(</span><span class="p" data-group-id="0973520181-4">)</span><span class="p">,</span><span class="w">     </span><span class="c1">%% Current version (1, 2, 3, ...)</span><span class="w">
    </span><span class="ss">upcast_from</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="0973520181-5">#{</span><span class="w">             </span><span class="c1">%% Version -&gt; Transform function</span><span class="w">
        </span><span class="nf">pos_integer</span><span class="p" data-group-id="0973520181-6">(</span><span class="p" data-group-id="0973520181-6">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="0973520181-7">(</span><span class="p" data-group-id="0973520181-8">(</span><span class="nf">map</span><span class="p" data-group-id="0973520181-9">(</span><span class="p" data-group-id="0973520181-9">)</span><span class="p" data-group-id="0973520181-8">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nf">map</span><span class="p" data-group-id="0973520181-10">(</span><span class="p" data-group-id="0973520181-10">)</span><span class="p" data-group-id="0973520181-7">)</span><span class="w">
    </span><span class="p" data-group-id="0973520181-5">}</span><span class="p">,</span><span class="w">
    </span><span class="ss">validator</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="0973520181-11">(</span><span class="p" data-group-id="0973520181-12">(</span><span class="nf">map</span><span class="p" data-group-id="0973520181-13">(</span><span class="p" data-group-id="0973520181-13">)</span><span class="p" data-group-id="0973520181-12">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="ss">ok</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p" data-group-id="0973520181-14">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="nf">term</span><span class="p" data-group-id="0973520181-15">(</span><span class="p" data-group-id="0973520181-15">)</span><span class="p" data-group-id="0973520181-14">}</span><span class="p" data-group-id="0973520181-11">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">description</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">binary</span><span class="p" data-group-id="0973520181-16">(</span><span class="p" data-group-id="0973520181-16">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">registered_at</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="nf">integer</span><span class="p" data-group-id="0973520181-17">(</span><span class="p" data-group-id="0973520181-17">)</span><span class="w">    </span><span class="c1">%% Timestamp</span><span class="w">
</span><span class="p" data-group-id="0973520181-2">}</span><span class="p">.</span></code></pre><h2 id="upcasting" class="section-heading"><a href="#upcasting" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Upcasting</span></h2><h3 id="how-upcasting-works" class="section-heading"><a href="#how-upcasting-works" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">How Upcasting Works</span></h3><p>When reading events, upcasting transforms old versions to the current schema:</p><pre><code class="makeup erlang" translate="no"><span class="c1">%% Read events (may contain multiple versions)</span><span class="w">
</span><span class="p" data-group-id="0880214677-1">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Events</span><span class="p" data-group-id="0880214677-1">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">reckon_db_streams</span><span class="p">:</span><span class="nf">read</span><span class="p" data-group-id="0880214677-2">(</span><span class="ss">my_store</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0880214677-3">&lt;&lt;</span><span class="s">&quot;orders-123&quot;</span><span class="p" data-group-id="0880214677-3">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="ss">forward</span><span class="p" data-group-id="0880214677-2">)</span><span class="p">,</span><span class="w">

</span><span class="c1">%% Upcast all events to current schema versions</span><span class="w">
</span><span class="n">UpcastedEvents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">reckon_db_schema</span><span class="p">:</span><span class="nf">upcast</span><span class="p" data-group-id="0880214677-4">(</span><span class="ss">my_store</span><span class="p">,</span><span class="w"> </span><span class="n">Events</span><span class="p" data-group-id="0880214677-4">)</span><span class="p">.</span></code></pre><h3 id="upcasting-flow" class="section-heading"><a href="#upcasting-flow" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Upcasting Flow</span></h3><pre><code class="makeup erlang" translate="no"><span class="n">Event</span><span class="w"> </span><span class="p" data-group-id="0487029555-1">(</span><span class="ss">v1</span><span class="p" data-group-id="0487029555-1">)</span><span class="w"> </span><span class="err">─</span><span class="err">─</span><span class="err">▶</span><span class="w"> </span><span class="ss">upcast_from</span><span class="p" data-group-id="0487029555-2">[</span><span class="mi">1</span><span class="p" data-group-id="0487029555-2">]</span><span class="w"> </span><span class="err">─</span><span class="err">─</span><span class="err">▶</span><span class="w"> </span><span class="n">Event</span><span class="w"> </span><span class="p" data-group-id="0487029555-3">(</span><span class="ss">v2</span><span class="p" data-group-id="0487029555-3">)</span><span class="w"> </span><span class="err">─</span><span class="err">─</span><span class="err">▶</span><span class="w"> </span><span class="ss">upcast_from</span><span class="p" data-group-id="0487029555-4">[</span><span class="mi">2</span><span class="p" data-group-id="0487029555-4">]</span><span class="w"> </span><span class="err">─</span><span class="err">─</span><span class="err">▶</span><span class="w"> </span><span class="n">Event</span><span class="w"> </span><span class="p" data-group-id="0487029555-5">(</span><span class="ss">v3</span><span class="p" data-group-id="0487029555-5">)</span></code></pre><p>Events are upcasted through each version step sequentially.</p><h3 id="version-detection" class="section-heading"><a href="#version-detection" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Version Detection</span></h3><p>Event versions are stored in metadata:</p><pre><code class="makeup erlang" translate="no"><span class="o">#</span><span class="ss">event</span><span class="p" data-group-id="3793761724-1">{</span><span class="w">
    </span><span class="ss">metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="3793761724-2">#{</span><span class="w">
        </span><span class="ss">schema_version</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">2</span><span class="w">  </span><span class="c1">%% Default: 1 if not present</span><span class="w">
    </span><span class="p" data-group-id="3793761724-2">}</span><span class="w">
</span><span class="p" data-group-id="3793761724-1">}</span></code></pre><p>After upcasting, the <code class="inline">schema_version</code> is updated:</p><pre><code class="makeup erlang" translate="no"><span class="c1">%% Before: schema_version =&gt; 1</span><span class="w">
</span><span class="c1">%% After upcast to v3: schema_version =&gt; 3</span></code></pre><h2 id="cluster-behavior" class="section-heading"><a href="#cluster-behavior" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Cluster Behavior</span></h2><h3 id="consistency" class="section-heading"><a href="#consistency" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Consistency</span></h3><p>Schema registration is replicated through Khepri/Ra:</p><ol><li>Schema registered on any node</li><li>Replicated through Raft consensus</li><li>Available on all cluster nodes</li></ol><h3 id="version-conflicts" class="section-heading"><a href="#version-conflicts" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Version Conflicts</span></h3><p>If different nodes have different schema versions:</p><ul><li>Upcasting uses the local node's schema</li><li>Ensure schema updates are coordinated</li><li>Use rolling updates for schema changes</li></ul><h2 id="evolution-strategies" class="section-heading"><a href="#evolution-strategies" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Evolution Strategies</span></h2><h3 id="1-additive-changes-safe" class="section-heading"><a href="#1-additive-changes-safe" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">1. Additive Changes (Safe)</span></h3><p>Add new optional fields:</p><pre><code class="makeup erlang" translate="no"><span class="c1">%% V1 -&gt; V2: Add optional field with default</span><span class="w">
</span><span class="mi">1</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="3996417606-1">(</span><span class="n">Data</span><span class="p" data-group-id="3996417606-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">maps</span><span class="p">:</span><span class="nf">put</span><span class="p" data-group-id="3996417606-2">(</span><span class="ss">priority</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="3996417606-3">&lt;&lt;</span><span class="s">&quot;normal&quot;</span><span class="p" data-group-id="3996417606-3">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="3996417606-2">)</span><span class="w">
</span><span class="k">end</span></code></pre><h3 id="2-renaming-fields" class="section-heading"><a href="#2-renaming-fields" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">2. Renaming Fields</span></h3><p>Rename while preserving data:</p><pre><code class="makeup erlang" translate="no"><span class="c1">%% V1 -&gt; V2: Rename customerId to customer_id</span><span class="w">
</span><span class="mi">1</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="0460366165-1">(</span><span class="n">Data</span><span class="p" data-group-id="0460366165-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">CustomerId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="0460366165-2">(</span><span class="ss">customerId</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="0460366165-2">)</span><span class="p">,</span><span class="w">
    </span><span class="nc">maps</span><span class="p">:</span><span class="nf">remove</span><span class="p" data-group-id="0460366165-3">(</span><span class="ss">customerId</span><span class="p">,</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">put</span><span class="p" data-group-id="0460366165-4">(</span><span class="ss">customer_id</span><span class="p">,</span><span class="w"> </span><span class="n">CustomerId</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="0460366165-4">)</span><span class="p" data-group-id="0460366165-3">)</span><span class="w">
</span><span class="k">end</span></code></pre><h3 id="3-splitting-fields" class="section-heading"><a href="#3-splitting-fields" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">3. Splitting Fields</span></h3><p>Split one field into multiple:</p><pre><code class="makeup erlang" translate="no"><span class="c1">%% V1 -&gt; V2: Split name into first_name and last_name</span><span class="w">
</span><span class="mi">1</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="0971977102-1">(</span><span class="n">Data</span><span class="p" data-group-id="0971977102-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="0971977102-2">(</span><span class="ss">name</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0971977102-3">&lt;&lt;</span><span class="s">&quot;&quot;</span><span class="p" data-group-id="0971977102-3">&gt;&gt;</span><span class="p" data-group-id="0971977102-2">)</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="0971977102-4">[</span><span class="n">First</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="n">Rest</span><span class="p" data-group-id="0971977102-4">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">binary</span><span class="p">:</span><span class="nf">split</span><span class="p" data-group-id="0971977102-5">(</span><span class="n">Name</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0971977102-6">&lt;&lt;</span><span class="s">&quot; &quot;</span><span class="p" data-group-id="0971977102-6">&gt;&gt;</span><span class="p" data-group-id="0971977102-5">)</span><span class="p">,</span><span class="w">
    </span><span class="n">Last</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">iolist_to_binary</span><span class="p" data-group-id="0971977102-7">(</span><span class="nc">lists</span><span class="p">:</span><span class="nf">join</span><span class="p" data-group-id="0971977102-8">(</span><span class="p" data-group-id="0971977102-9">&lt;&lt;</span><span class="s">&quot; &quot;</span><span class="p" data-group-id="0971977102-9">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">Rest</span><span class="p" data-group-id="0971977102-8">)</span><span class="p" data-group-id="0971977102-7">)</span><span class="p">,</span><span class="w">
    </span><span class="n">Data2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">remove</span><span class="p" data-group-id="0971977102-10">(</span><span class="ss">name</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="0971977102-10">)</span><span class="p">,</span><span class="w">
    </span><span class="nc">maps</span><span class="p">:</span><span class="nf">merge</span><span class="p" data-group-id="0971977102-11">(</span><span class="n">Data2</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0971977102-12">#{</span><span class="ss">first_name</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">First</span><span class="p">,</span><span class="w"> </span><span class="ss">last_name</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">Last</span><span class="p" data-group-id="0971977102-12">}</span><span class="p" data-group-id="0971977102-11">)</span><span class="w">
</span><span class="k">end</span></code></pre><h3 id="4-merging-fields" class="section-heading"><a href="#4-merging-fields" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">4. Merging Fields</span></h3><p>Combine multiple fields:</p><pre><code class="makeup erlang" translate="no"><span class="c1">%% V1 -&gt; V2: Merge address fields into address map</span><span class="w">
</span><span class="mi">1</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="8864371201-1">(</span><span class="n">Data</span><span class="p" data-group-id="8864371201-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">Address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="8864371201-2">#{</span><span class="w">
        </span><span class="ss">street</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="8864371201-3">(</span><span class="ss">street</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8864371201-4">&lt;&lt;</span><span class="s">&quot;&quot;</span><span class="p" data-group-id="8864371201-4">&gt;&gt;</span><span class="p" data-group-id="8864371201-3">)</span><span class="p">,</span><span class="w">
        </span><span class="ss">city</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="8864371201-5">(</span><span class="ss">city</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8864371201-6">&lt;&lt;</span><span class="s">&quot;&quot;</span><span class="p" data-group-id="8864371201-6">&gt;&gt;</span><span class="p" data-group-id="8864371201-5">)</span><span class="p">,</span><span class="w">
        </span><span class="ss">zip</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="8864371201-7">(</span><span class="ss">zip</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8864371201-8">&lt;&lt;</span><span class="s">&quot;&quot;</span><span class="p" data-group-id="8864371201-8">&gt;&gt;</span><span class="p" data-group-id="8864371201-7">)</span><span class="w">
    </span><span class="p" data-group-id="8864371201-2">}</span><span class="p">,</span><span class="w">
    </span><span class="n">Data2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">without</span><span class="p" data-group-id="8864371201-9">(</span><span class="p" data-group-id="8864371201-10">[</span><span class="ss">street</span><span class="p">,</span><span class="w"> </span><span class="ss">city</span><span class="p">,</span><span class="w"> </span><span class="ss">zip</span><span class="p" data-group-id="8864371201-10">]</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="8864371201-9">)</span><span class="p">,</span><span class="w">
    </span><span class="nc">maps</span><span class="p">:</span><span class="nf">put</span><span class="p" data-group-id="8864371201-11">(</span><span class="ss">address</span><span class="p">,</span><span class="w"> </span><span class="n">Address</span><span class="p">,</span><span class="w"> </span><span class="n">Data2</span><span class="p" data-group-id="8864371201-11">)</span><span class="w">
</span><span class="k">end</span></code></pre><h3 id="5-type-changes" class="section-heading"><a href="#5-type-changes" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">5. Type Changes</span></h3><p>Convert field types:</p><pre><code class="makeup erlang" translate="no"><span class="c1">%% V1 -&gt; V2: Convert amount from cents (integer) to dollars (float)</span><span class="w">
</span><span class="mi">1</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="2628536612-1">(</span><span class="n">Data</span><span class="p" data-group-id="2628536612-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">Cents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="2628536612-2">(</span><span class="ss">amount</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="2628536612-2">)</span><span class="p">,</span><span class="w">
    </span><span class="n">Dollars</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cents</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">100.0</span><span class="p">,</span><span class="w">
    </span><span class="nc">maps</span><span class="p">:</span><span class="nf">put</span><span class="p" data-group-id="2628536612-3">(</span><span class="ss">amount</span><span class="p">,</span><span class="w"> </span><span class="n">Dollars</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="2628536612-3">)</span><span class="w">
</span><span class="k">end</span></code></pre><h2 id="validation" class="section-heading"><a href="#validation" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Validation</span></h2><h3 id="on-write" class="section-heading"><a href="#on-write" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">On Write</span></h3><p>Validate events before appending:</p><pre><code class="makeup erlang" translate="no"><span class="n">Event</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">#</span><span class="ss">event</span><span class="p" data-group-id="6054988406-1">{</span><span class="ss">event_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="6054988406-2">&lt;&lt;</span><span class="s">&quot;OrderPlaced&quot;</span><span class="p" data-group-id="6054988406-2">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="ss">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="6054988406-3">#{</span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="p" data-group-id="6054988406-3">}</span><span class="p" data-group-id="6054988406-1">}</span><span class="p">,</span><span class="w">
</span><span class="k">case</span><span class="w"> </span><span class="nc">reckon_db_schema</span><span class="p">:</span><span class="nf">validate</span><span class="p" data-group-id="6054988406-4">(</span><span class="ss">my_store</span><span class="p">,</span><span class="w"> </span><span class="n">Event</span><span class="p" data-group-id="6054988406-4">)</span><span class="w"> </span><span class="k">of</span><span class="w">
    </span><span class="ss">ok</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="nc">reckon_db_streams</span><span class="p">:</span><span class="nf">append</span><span class="p" data-group-id="6054988406-5">(</span><span class="ss">my_store</span><span class="p">,</span><span class="w"> </span><span class="n">StreamId</span><span class="p">,</span><span class="w"> </span><span class="n">ExpectedVersion</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6054988406-6">[</span><span class="n">Event</span><span class="p" data-group-id="6054988406-6">]</span><span class="p" data-group-id="6054988406-5">)</span><span class="p">;</span><span class="w">
    </span><span class="p" data-group-id="6054988406-7">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="6054988406-7">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="p" data-group-id="6054988406-8">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6054988406-9">{</span><span class="ss">validation_failed</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="6054988406-9">}</span><span class="p" data-group-id="6054988406-8">}</span><span class="w">
</span><span class="k">end</span></code></pre><h3 id="custom-validators" class="section-heading"><a href="#custom-validators" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Custom Validators</span></h3><pre><code class="makeup erlang" translate="no"><span class="ss">validator</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="1697909210-1">(</span><span class="n">Data</span><span class="p" data-group-id="1697909210-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">Amount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="1697909210-2">(</span><span class="ss">amount</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="1697909210-2">)</span><span class="p">,</span><span class="w">
    </span><span class="n">Currency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="1697909210-3">(</span><span class="ss">currency</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p">,</span><span class="w"> </span><span class="ss">undefined</span><span class="p" data-group-id="1697909210-3">)</span><span class="p">,</span><span class="w">

    </span><span class="k">case</span><span class="w"> </span><span class="p" data-group-id="1697909210-4">{</span><span class="n">Amount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">Currency</span><span class="w"> </span><span class="o">=/=</span><span class="w"> </span><span class="ss">undefined</span><span class="p" data-group-id="1697909210-4">}</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="p" data-group-id="1697909210-5">{</span><span class="ss">true</span><span class="p">,</span><span class="w"> </span><span class="ss">true</span><span class="p" data-group-id="1697909210-5">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="ss">ok</span><span class="p">;</span><span class="w">
        </span><span class="p" data-group-id="1697909210-6">{</span><span class="ss">false</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="p" data-group-id="1697909210-6">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p" data-group-id="1697909210-7">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1697909210-8">{</span><span class="ss">invalid_amount</span><span class="p">,</span><span class="w"> </span><span class="n">Amount</span><span class="p" data-group-id="1697909210-8">}</span><span class="p" data-group-id="1697909210-7">}</span><span class="p">;</span><span class="w">
        </span><span class="p" data-group-id="1697909210-9">{</span><span class="p">_</span><span class="p">,</span><span class="w"> </span><span class="ss">false</span><span class="p" data-group-id="1697909210-9">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p" data-group-id="1697909210-10">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">missing_currency</span><span class="p" data-group-id="1697909210-10">}</span><span class="w">
    </span><span class="k">end</span><span class="w">
</span><span class="k">end</span></code></pre><h2 id="querying-schemas" class="section-heading"><a href="#querying-schemas" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Querying Schemas</span></h2><h3 id="list-all-schemas" class="section-heading"><a href="#list-all-schemas" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">List All Schemas</span></h3><pre><code class="makeup erlang" translate="no"><span class="p" data-group-id="1706001925-1">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Schemas</span><span class="p" data-group-id="1706001925-1">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">reckon_db_schema</span><span class="p">:</span><span class="nf">list</span><span class="p" data-group-id="1706001925-2">(</span><span class="ss">my_store</span><span class="p" data-group-id="1706001925-2">)</span><span class="p">,</span><span class="w">
</span><span class="c1">%% [#{event_type =&gt; &lt;&lt;&quot;OrderPlaced&quot;&gt;&gt;, version =&gt; 3, registered_at =&gt; ...}, ...]</span></code></pre><h3 id="get-specific-schema" class="section-heading"><a href="#get-specific-schema" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Get Specific Schema</span></h3><pre><code class="makeup erlang" translate="no"><span class="p" data-group-id="7813192945-1">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Schema</span><span class="p" data-group-id="7813192945-1">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">reckon_db_schema</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="7813192945-2">(</span><span class="ss">my_store</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7813192945-3">&lt;&lt;</span><span class="s">&quot;OrderPlaced&quot;</span><span class="p" data-group-id="7813192945-3">&gt;&gt;</span><span class="p" data-group-id="7813192945-2">)</span><span class="p">,</span><span class="w">
</span><span class="c1">%% #{event_type =&gt; &lt;&lt;&quot;OrderPlaced&quot;&gt;&gt;, version =&gt; 3, upcast_from =&gt; #{...}, ...}</span></code></pre><h3 id="get-current-version" class="section-heading"><a href="#get-current-version" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Get Current Version</span></h3><pre><code class="makeup erlang" translate="no"><span class="p" data-group-id="0403024683-1">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Version</span><span class="p" data-group-id="0403024683-1">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">reckon_db_schema</span><span class="p">:</span><span class="nf">get_version</span><span class="p" data-group-id="0403024683-2">(</span><span class="ss">my_store</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0403024683-3">&lt;&lt;</span><span class="s">&quot;OrderPlaced&quot;</span><span class="p" data-group-id="0403024683-3">&gt;&gt;</span><span class="p" data-group-id="0403024683-2">)</span><span class="p">,</span><span class="w">
</span><span class="c1">%% 3</span></code></pre><h2 id="telemetry" class="section-heading"><a href="#telemetry" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Telemetry</span></h2><p>Schema operations emit telemetry:</p><pre><code class="makeup erlang" translate="no"><span class="c1">%% Registration/unregistration</span><span class="w">
</span><span class="c1">%% Event: [reckon_db, schema, registered | unregistered]</span><span class="w">
</span><span class="c1">%% Measurements: #{version =&gt; integer()}</span><span class="w">
</span><span class="c1">%% Metadata: #{store_id =&gt; atom(), event_type =&gt; binary()}</span><span class="w">

</span><span class="c1">%% Upcasting</span><span class="w">
</span><span class="c1">%% Event: [reckon_db, schema, upcasted]</span><span class="w">
</span><span class="c1">%% Measurements: #{duration =&gt; integer()}</span><span class="w">
</span><span class="c1">%% Metadata: #{store_id =&gt; atom(), event_type =&gt; binary(),</span><span class="w">
</span><span class="c1">%%             from_version =&gt; integer(), to_version =&gt; integer()}</span></code></pre><h2 id="best-practices" class="section-heading"><a href="#best-practices" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Best Practices</span></h2><h3 id="1-never-remove-required-fields" class="section-heading"><a href="#1-never-remove-required-fields" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">1. Never Remove Required Fields</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% BAD: Field removed without migration</span><span class="w">
</span><span class="c1">%% V1: #{order_id, customer_id, items}</span><span class="w">
</span><span class="c1">%% V2: #{order_id, items}  -- customer_id removed!</span><span class="w">

</span><span class="c1">%% GOOD: Deprecate, then remove in later version</span><span class="w">
</span><span class="c1">%% V1 -&gt; V2: Mark deprecated</span><span class="w">
</span><span class="c1">%% V2 -&gt; V3: Actually remove (after all consumers updated)</span></code></pre><h3 id="2-make-new-fields-optional" class="section-heading"><a href="#2-make-new-fields-optional" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">2. Make New Fields Optional</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% GOOD: New field has default value</span><span class="w">
</span><span class="mi">1</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="4414198709-1">(</span><span class="n">Data</span><span class="p" data-group-id="4414198709-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">maps</span><span class="p">:</span><span class="nf">put_new</span><span class="p" data-group-id="4414198709-2">(</span><span class="ss">priority</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4414198709-3">&lt;&lt;</span><span class="s">&quot;normal&quot;</span><span class="p" data-group-id="4414198709-3">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="4414198709-2">)</span><span class="w">
</span><span class="k">end</span></code></pre><h3 id="3-test-upcasting-thoroughly" class="section-heading"><a href="#3-test-upcasting-thoroughly" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">3. Test Upcasting Thoroughly</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% Test each version transition</span><span class="w">
</span><span class="nf">test_v1_to_v2</span><span class="p" data-group-id="7259323656-1">(</span><span class="p" data-group-id="7259323656-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">V1Data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="7259323656-2">#{</span><span class="ss">order_id</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="7259323656-3">&lt;&lt;</span><span class="s">&quot;123&quot;</span><span class="p" data-group-id="7259323656-3">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="ss">customerId</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="7259323656-4">&lt;&lt;</span><span class="s">&quot;cust-1&quot;</span><span class="p" data-group-id="7259323656-4">&gt;&gt;</span><span class="p" data-group-id="7259323656-2">}</span><span class="p">,</span><span class="w">
    </span><span class="n">V2Data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">upcast_v1_to_v2</span><span class="p" data-group-id="7259323656-5">(</span><span class="n">V1Data</span><span class="p" data-group-id="7259323656-5">)</span><span class="p">,</span><span class="w">
    </span><span class="o">?</span><span class="nf">assertEqual</span><span class="p" data-group-id="7259323656-6">(</span><span class="p" data-group-id="7259323656-7">&lt;&lt;</span><span class="s">&quot;cust-1&quot;</span><span class="p" data-group-id="7259323656-7">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="7259323656-8">(</span><span class="ss">customer_id</span><span class="p">,</span><span class="w"> </span><span class="n">V2Data</span><span class="p" data-group-id="7259323656-8">)</span><span class="p" data-group-id="7259323656-6">)</span><span class="p">,</span><span class="w">
    </span><span class="o">?</span><span class="nf">assertNot</span><span class="p" data-group-id="7259323656-9">(</span><span class="nc">maps</span><span class="p">:</span><span class="nf">is_key</span><span class="p" data-group-id="7259323656-10">(</span><span class="ss">customerId</span><span class="p">,</span><span class="w"> </span><span class="n">V2Data</span><span class="p" data-group-id="7259323656-10">)</span><span class="p" data-group-id="7259323656-9">)</span><span class="p">.</span></code></pre><h3 id="4-version-incrementally" class="section-heading"><a href="#4-version-incrementally" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">4. Version Incrementally</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% GOOD: One version per change</span><span class="w">
</span><span class="c1">%% V1 -&gt; V2: Add field</span><span class="w">
</span><span class="c1">%% V2 -&gt; V3: Rename field</span><span class="w">
</span><span class="c1">%% V3 -&gt; V4: Change type</span><span class="w">

</span><span class="c1">%% BAD: Multiple changes per version</span><span class="w">
</span><span class="c1">%% V1 -&gt; V2: Add field AND rename field AND change type</span></code></pre><h3 id="5-document-schema-changes" class="section-heading"><a href="#5-document-schema-changes" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">5. Document Schema Changes</span></h3><pre><code class="makeup erlang" translate="no"><span class="ss">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">reckon_db_schema</span><span class="p">:</span><span class="nf">register</span><span class="p" data-group-id="6691784332-1">(</span><span class="ss">my_store</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6691784332-2">&lt;&lt;</span><span class="s">&quot;OrderPlaced&quot;</span><span class="p" data-group-id="6691784332-2">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6691784332-3">#{</span><span class="w">
    </span><span class="ss">version</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w">
    </span><span class="ss">description</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="6691784332-4">&lt;&lt;</span><span class="s">&quot;V3: Renamed customer_id to buyer_id for consistency&quot;</span><span class="p" data-group-id="6691784332-4">&gt;&gt;</span><span class="p">,</span><span class="w">
    </span><span class="ss">upcast_from</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="6691784332-5">#{</span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="p" data-group-id="6691784332-5">}</span><span class="w">
</span><span class="p" data-group-id="6691784332-3">}</span><span class="p" data-group-id="6691784332-1">)</span><span class="p">.</span></code></pre><h2 id="error-handling" class="section-heading"><a href="#error-handling" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Error Handling</span></h2><table><thead><tr><th style="text-align: left;">Error</th><th style="text-align: left;">Cause</th><th style="text-align: left;">Resolution</th></tr></thead><tbody><tr><td style="text-align: left;"><code class="inline">{error, {invalid_version, V}}</code></td><td style="text-align: left;">Version not positive integer</td><td style="text-align: left;">Use version &gt;= 1</td></tr><tr><td style="text-align: left;"><code class="inline">{error, not_found}</code></td><td style="text-align: left;">Schema not registered</td><td style="text-align: left;">Register schema first</td></tr><tr><td style="text-align: left;">Upcast crash</td><td style="text-align: left;">Upcast function threw</td><td style="text-align: left;">Event returned unchanged, logged</td></tr></tbody></table><h2 id="see-also" class="section-heading"><a href="#see-also" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">See Also</span></h2><ul><li><a href="event_sourcing.html">Event Sourcing</a> - Event design principles</li><li><a href="subscriptions.html">Subscriptions</a> - Event consumption</li><li><a href="storage_internals.html">Storage Internals</a> - Khepri path structure</li></ul>

</div>

<div class="bottom-actions" id="bottom-actions">
  <div class="bottom-actions-item">

      <a href="stream_links.html" class="bottom-actions-button" rel="prev">
        <span class="subheader">
          ← Previous Page
        </span>
        <span class="title">
Stream Links
        </span>
      </a>

  </div>
  <div class="bottom-actions-item">

      <a href="configuration.html" class="bottom-actions-button" rel="next">
        <span class="subheader">
          Next Page →
        </span>
        <span class="title">
Configuration
        </span>
      </a>

  </div>
</div>
    <footer class="footer">
      <p>

          <span class="line">
            <a href="https://hex.pm/packages/reckon_db/1.1.0" class="footer-hex-package">Hex Package</a>

            <a href="https://preview.hex.pm/preview/reckon_db/1.1.0">Hex Preview</a>

              (<a href="https://preview.hex.pm/preview/reckon_db/1.1.0/show/guides/schema_evolution.md">current file</a>)

          </span>

        <span class="line">
          <button class="a-main footer-button display-quick-switch" title="Search HexDocs packages">
            Search HexDocs
          </button>

            <a href="reckon_db.epub" title="ePub version">
              Download ePub version
            </a>

        </span>
      </p>

      <p class="built-using">
        Built using
        <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.38.2) for the

          <a href="https://erlang.org" title="Erlang" target="_blank" translate="no">Erlang programming language</a>

      </p>

    </footer>
  </div>
</main>
</div>

  </body>
</html>
