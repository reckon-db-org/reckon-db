<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.38.2">
    <meta name="project" content="reckon_db v1.2.0">


    <title>Storage Internals — reckon_db v1.2.0</title>

    <link rel="stylesheet" href="dist/html-erlang-DQDXQC7W.css" />

    <script defer src="dist/sidebar_items-BCF13423.js"></script>
    <script defer src="docs_config.js"></script>
    <script defer src="dist/html-DPJLHKSM.js"></script>

  </head>
  <body>
    <script>(()=>{var t="ex_doc:settings",e="dark";var o="dark",s="light";var E="sidebar_state",n="closed";var r="sidebar_width";var a="sidebar-open";var i=new URLSearchParams(window.location.search),S=i.get("theme")||JSON.parse(localStorage.getItem(t)||"{}").theme;(S===o||S!==s&&window.matchMedia("(prefers-color-scheme: dark)").matches)&&document.body.classList.add(e);var d=sessionStorage.getItem(E),A=d!==n&&!window.matchMedia(`screen and (max-width: ${768}px)`).matches;document.body.classList.toggle(a,A);var c=sessionStorage.getItem(r);c&&document.body.style.setProperty("--sidebarWidth",`${c}px`);var p=/(Macintosh|iPhone|iPad|iPod)/.test(window.navigator.userAgent);document.documentElement.classList.toggle("apple-os",p);})();
</script>

<div class="body-wrapper">

<button id="sidebar-menu" class="sidebar-button sidebar-toggle" aria-label="toggle sidebar" aria-controls="sidebar">
  <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
</button>

<nav id="sidebar" class="sidebar">

  <div class="sidebar-header">
    <div class="sidebar-projectInfo">

      <div>
        <a href="readme.html" class="sidebar-projectName" translate="no">
reckon_db
        </a>
        <div class="sidebar-projectVersion" translate="no">
          v1.2.0
        </div>
      </div>
    </div>
    <ul id="sidebar-list-nav" class="sidebar-list-nav" role="tablist" data-extras=""></ul>
  </div>
</nav>

<output role="status" id="toast"></output>

<main class="content page-extra" id="main" data-type="extras">
  <div id="content" class="content-inner">
    <div class="top-search">
      <div class="search-settings">
        <form class="search-bar" action="search.html">
          <label class="search-label">
            <span class="sr-only">Search documentation of reckon_db</span>
            <input name="q" type="text" class="search-input" placeholder="Press / to search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
          </label>
          <button type="submit" class="search-button" aria-label="Submit Search" tabindex="-1">
            <i class="ri-search-2-line ri-lg" aria-hidden="true"></i>
          </button>
          <button type="button" tabindex="-1" class="search-close-button" aria-hidden="true">
            <i class="ri-close-line ri-lg" title="Cancel search"></i>
          </button>
        </form>
        <div class="autocomplete">
        </div>
        <button class="icon-settings display-settings">
          <i class="ri-settings-3-line"></i>
          <span class="sr-only">Settings</span>
        </button>
      </div>
    </div>

<div id="top-content">
  <div class="heading-with-actions top-heading">
    <h1>Storage Internals</h1>


      <a href="https://github.com/reckon-db-org/reckon-db/blob/v1.2.0/guides/storage_internals.md#L1" title="View Source" class="icon-action" rel="help">
        <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        <span class="sr-only">View Source</span>
      </a>

  </div>


<p>This guide covers the internal storage architecture of reckon-db, including Khepri path structures, data organization, and cluster replication behavior.</p><h2 id="overview" class="section-heading"><a href="#overview" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Overview</span></h2><p>reckon-db uses <strong>Khepri</strong> as its storage layer. Khepri is a tree-like key-value store built on Ra (Raft consensus), providing:</p><ul><li>Strong consistency across cluster nodes</li><li>Automatic replication</li><li>Tree-structured data organization</li><li>Efficient prefix queries</li></ul><h2 id="architecture" class="section-heading"><a href="#architecture" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Architecture</span></h2><p><img src="../assets/khepri_paths.svg" alt="Khepri Storage Paths"/></p><h2 id="khepri-path-structure" class="section-heading"><a href="#khepri-path-structure" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Khepri Path Structure</span></h2><p>All data is organized under hierarchical paths:</p><pre><code class="makeup erlang" translate="no"><span class="p" data-group-id="5726942475-1">[</span><span class="ss">root</span><span class="p" data-group-id="5726942475-1">]</span><span class="w">
</span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="p" data-group-id="5726942475-2">[</span><span class="ss">streams</span><span class="p" data-group-id="5726942475-2">]</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="p" data-group-id="5726942475-3">[</span><span class="n">StreamId</span><span class="p" data-group-id="5726942475-3">]</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="p" data-group-id="5726942475-4">[</span><span class="n">PaddedVersion</span><span class="p" data-group-id="5726942475-4">]</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="o">#</span><span class="ss">event</span><span class="p" data-group-id="5726942475-5">{</span><span class="p" data-group-id="5726942475-5">}</span><span class="w">
</span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="p" data-group-id="5726942475-6">[</span><span class="ss">snapshots</span><span class="p" data-group-id="5726942475-6">]</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="p" data-group-id="5726942475-7">[</span><span class="n">StreamId</span><span class="p" data-group-id="5726942475-7">]</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="p" data-group-id="5726942475-8">[</span><span class="n">PaddedVersion</span><span class="p" data-group-id="5726942475-8">]</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="o">#</span><span class="ss">snapshot</span><span class="p" data-group-id="5726942475-9">{</span><span class="p" data-group-id="5726942475-9">}</span><span class="w">
</span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="p" data-group-id="5726942475-10">[</span><span class="ss">subscriptions</span><span class="p" data-group-id="5726942475-10">]</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="p" data-group-id="5726942475-11">[</span><span class="n">SubscriptionName</span><span class="p" data-group-id="5726942475-11">]</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="o">#</span><span class="ss">subscription</span><span class="p" data-group-id="5726942475-12">{</span><span class="p" data-group-id="5726942475-12">}</span><span class="w">
</span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="p" data-group-id="5726942475-13">[</span><span class="ss">schemas</span><span class="p" data-group-id="5726942475-13">]</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="p" data-group-id="5726942475-14">[</span><span class="n">StoreId</span><span class="p" data-group-id="5726942475-14">]</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="p" data-group-id="5726942475-15">[</span><span class="n">EventType</span><span class="p" data-group-id="5726942475-15">]</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nf">schema_map</span><span class="p" data-group-id="5726942475-16">(</span><span class="p" data-group-id="5726942475-16">)</span><span class="w">
</span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="p" data-group-id="5726942475-17">[</span><span class="ss">links</span><span class="p" data-group-id="5726942475-17">]</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="p" data-group-id="5726942475-18">[</span><span class="n">StoreId</span><span class="p" data-group-id="5726942475-18">]</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="p" data-group-id="5726942475-19">[</span><span class="n">LinkName</span><span class="p" data-group-id="5726942475-19">]</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="o">#</span><span class="nb">link</span><span class="p" data-group-id="5726942475-20">{</span><span class="p" data-group-id="5726942475-20">}</span><span class="w">
</span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="p" data-group-id="5726942475-21">[</span><span class="ss">metadata</span><span class="p" data-group-id="5726942475-21">]</span><span class="w">
    </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="p" data-group-id="5726942475-22">[</span><span class="n">Key</span><span class="p" data-group-id="5726942475-22">]</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="n">Value</span></code></pre><h2 id="streams-storage" class="section-heading"><a href="#streams-storage" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Streams Storage</span></h2><h3 id="path-format" class="section-heading"><a href="#path-format" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Path Format</span></h3><pre><code class="makeup erlang" translate="no"><span class="o">?</span><span class="n">STREAMS_PATH</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="p" data-group-id="2428297440-1">[</span><span class="n">StreamId</span><span class="p">,</span><span class="w"> </span><span class="n">PaddedVersion</span><span class="p" data-group-id="2428297440-1">]</span><span class="w">
</span><span class="c1">%% Example: [streams, &lt;&lt;&quot;orders-123&quot;&gt;&gt;, &lt;&lt;&quot;000000000042&quot;&gt;&gt;]</span></code></pre><h3 id="version-padding" class="section-heading"><a href="#version-padding" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Version Padding</span></h3><p>Versions are zero-padded to 12 characters for lexicographic ordering:</p><pre><code class="makeup erlang" translate="no"><span class="p">-</span><span class="na">define</span><span class="p" data-group-id="9994293703-1">(</span><span class="n">VERSION_PADDING</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p" data-group-id="9994293703-1">)</span><span class="p">.</span><span class="w">

</span><span class="nf">pad_version</span><span class="p" data-group-id="9994293703-2">(</span><span class="n">Version</span><span class="p">,</span><span class="w"> </span><span class="n">Length</span><span class="p" data-group-id="9994293703-2">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">VersionStr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">integer_to_list</span><span class="p" data-group-id="9994293703-3">(</span><span class="n">Version</span><span class="p" data-group-id="9994293703-3">)</span><span class="p">,</span><span class="w">
    </span><span class="n">Padding</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nf">length</span><span class="p" data-group-id="9994293703-4">(</span><span class="n">VersionStr</span><span class="p" data-group-id="9994293703-4">)</span><span class="p">,</span><span class="w">
    </span><span class="n">PaddedStr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">lists</span><span class="p">:</span><span class="nf">duplicate</span><span class="p" data-group-id="9994293703-5">(</span><span class="n">Padding</span><span class="p">,</span><span class="w"> </span><span class="sc">$0</span><span class="p" data-group-id="9994293703-5">)</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="n">VersionStr</span><span class="p">,</span><span class="w">
    </span><span class="nf">list_to_binary</span><span class="p" data-group-id="9994293703-6">(</span><span class="n">PaddedStr</span><span class="p" data-group-id="9994293703-6">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Examples:</span><span class="w">
</span><span class="c1">%% 0 -&gt; &lt;&lt;&quot;000000000000&quot;&gt;&gt;</span><span class="w">
</span><span class="c1">%% 42 -&gt; &lt;&lt;&quot;000000000042&quot;&gt;&gt;</span><span class="w">
</span><span class="c1">%% 999999999999 -&gt; &lt;&lt;&quot;999999999999&quot;&gt;&gt;</span></code></pre><p>This supports up to 999,999,999,999 events per stream (~317 years at 100 events/sec).</p><h3 id="event-record" class="section-heading"><a href="#event-record" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Event Record</span></h3><pre><code class="makeup erlang" translate="no"><span class="p">-</span><span class="na">record</span><span class="p" data-group-id="5302184150-1">(</span><span class="ss">event</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5302184150-2">{</span><span class="w">
    </span><span class="ss">event_id</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">binary</span><span class="p" data-group-id="5302184150-3">(</span><span class="p" data-group-id="5302184150-3">)</span><span class="p">,</span><span class="w">           </span><span class="c1">%% UUID</span><span class="w">
    </span><span class="ss">stream_id</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">binary</span><span class="p" data-group-id="5302184150-4">(</span><span class="p" data-group-id="5302184150-4">)</span><span class="p">,</span><span class="w">          </span><span class="c1">%% Stream identifier</span><span class="w">
    </span><span class="ss">version</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">non_neg_integer</span><span class="p" data-group-id="5302184150-5">(</span><span class="p" data-group-id="5302184150-5">)</span><span class="p">,</span><span class="w">   </span><span class="c1">%% 0-indexed position</span><span class="w">
    </span><span class="ss">event_type</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">binary</span><span class="p" data-group-id="5302184150-6">(</span><span class="p" data-group-id="5302184150-6">)</span><span class="p">,</span><span class="w">         </span><span class="c1">%% Event type name</span><span class="w">
    </span><span class="ss">data</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">map</span><span class="p" data-group-id="5302184150-7">(</span><span class="p" data-group-id="5302184150-7">)</span><span class="p">,</span><span class="w">                  </span><span class="c1">%% Event payload</span><span class="w">
    </span><span class="ss">metadata</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">map</span><span class="p" data-group-id="5302184150-8">(</span><span class="p" data-group-id="5302184150-8">)</span><span class="p">,</span><span class="w">              </span><span class="c1">%% Event metadata</span><span class="w">
    </span><span class="ss">epoch_us</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">integer</span><span class="p" data-group-id="5302184150-9">(</span><span class="p" data-group-id="5302184150-9">)</span><span class="w">           </span><span class="c1">%% Timestamp (microseconds since epoch)</span><span class="w">
</span><span class="p" data-group-id="5302184150-2">}</span><span class="p" data-group-id="5302184150-1">)</span><span class="p">.</span></code></pre><h3 id="reading-events" class="section-heading"><a href="#reading-events" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Reading Events</span></h3><p>Events are read using Khepri path queries:</p><pre><code class="makeup erlang" translate="no"><span class="c1">%% Read specific version</span><span class="w">
</span><span class="nc">khepri</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="5546424588-1">(</span><span class="n">StoreId</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5546424588-2">[</span><span class="ss">streams</span><span class="p">,</span><span class="w"> </span><span class="n">StreamId</span><span class="p">,</span><span class="w"> </span><span class="n">PaddedVersion</span><span class="p" data-group-id="5546424588-2">]</span><span class="p" data-group-id="5546424588-1">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Read range of versions</span><span class="w">
</span><span class="n">Pattern</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="5546424588-3">[</span><span class="ss">streams</span><span class="p">,</span><span class="w"> </span><span class="n">StreamId</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="n">KHEPRI_WILDCARD_STAR</span><span class="p" data-group-id="5546424588-3">]</span><span class="p">,</span><span class="w">
</span><span class="nc">khepri</span><span class="p">:</span><span class="nf">get_many</span><span class="p" data-group-id="5546424588-4">(</span><span class="n">StoreId</span><span class="p">,</span><span class="w"> </span><span class="n">Pattern</span><span class="p" data-group-id="5546424588-4">)</span><span class="p">.</span></code></pre><h2 id="snapshots-storage" class="section-heading"><a href="#snapshots-storage" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Snapshots Storage</span></h2><h3 id="path-format-1" class="section-heading"><a href="#path-format-1" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Path Format</span></h3><pre><code class="makeup erlang" translate="no"><span class="o">?</span><span class="n">SNAPSHOTS_PATH</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="p" data-group-id="3535462681-1">[</span><span class="n">StreamId</span><span class="p">,</span><span class="w"> </span><span class="n">PaddedVersion</span><span class="p" data-group-id="3535462681-1">]</span><span class="w">
</span><span class="c1">%% Example: [snapshots, &lt;&lt;&quot;orders-123&quot;&gt;&gt;, &lt;&lt;&quot;000000000100&quot;&gt;&gt;]</span></code></pre><h3 id="snapshot-record" class="section-heading"><a href="#snapshot-record" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Snapshot Record</span></h3><pre><code class="makeup erlang" translate="no"><span class="p">-</span><span class="na">record</span><span class="p" data-group-id="1206254677-1">(</span><span class="ss">snapshot</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1206254677-2">{</span><span class="w">
    </span><span class="ss">stream_id</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">binary</span><span class="p" data-group-id="1206254677-3">(</span><span class="p" data-group-id="1206254677-3">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">version</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">non_neg_integer</span><span class="p" data-group-id="1206254677-4">(</span><span class="p" data-group-id="1206254677-4">)</span><span class="p">,</span><span class="w">   </span><span class="c1">%% Event version this snapshot represents</span><span class="w">
    </span><span class="ss">state</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">term</span><span class="p" data-group-id="1206254677-5">(</span><span class="p" data-group-id="1206254677-5">)</span><span class="p">,</span><span class="w">                </span><span class="c1">%% Serialized aggregate state</span><span class="w">
    </span><span class="ss">metadata</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">map</span><span class="p" data-group-id="1206254677-6">(</span><span class="p" data-group-id="1206254677-6">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">created_at</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">integer</span><span class="p" data-group-id="1206254677-7">(</span><span class="p" data-group-id="1206254677-7">)</span><span class="w">         </span><span class="c1">%% Timestamp</span><span class="w">
</span><span class="p" data-group-id="1206254677-2">}</span><span class="p" data-group-id="1206254677-1">)</span><span class="p">.</span></code></pre><h3 id="latest-snapshot-query" class="section-heading"><a href="#latest-snapshot-query" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Latest Snapshot Query</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% Get all snapshots for a stream, sorted by version descending</span><span class="w">
</span><span class="n">Pattern</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="2102533899-1">[</span><span class="ss">snapshots</span><span class="p">,</span><span class="w"> </span><span class="n">StreamId</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="n">KHEPRI_WILDCARD_STAR</span><span class="p" data-group-id="2102533899-1">]</span><span class="p">,</span><span class="w">
</span><span class="p" data-group-id="2102533899-2">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Snapshots</span><span class="p" data-group-id="2102533899-2">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">khepri</span><span class="p">:</span><span class="nf">get_many</span><span class="p" data-group-id="2102533899-3">(</span><span class="n">StoreId</span><span class="p">,</span><span class="w"> </span><span class="n">Pattern</span><span class="p" data-group-id="2102533899-3">)</span><span class="p">,</span><span class="w">
</span><span class="c1">%% Sort by version descending to get latest first</span></code></pre><h2 id="subscriptions-storage" class="section-heading"><a href="#subscriptions-storage" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Subscriptions Storage</span></h2><h3 id="path-format-2" class="section-heading"><a href="#path-format-2" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Path Format</span></h3><pre><code class="makeup erlang" translate="no"><span class="o">?</span><span class="n">SUBSCRIPTIONS_PATH</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="p" data-group-id="8610111253-1">[</span><span class="n">SubscriptionName</span><span class="p" data-group-id="8610111253-1">]</span><span class="w">
</span><span class="c1">%% Example: [subscriptions, &lt;&lt;&quot;my-projection&quot;&gt;&gt;]</span></code></pre><h3 id="subscription-record" class="section-heading"><a href="#subscription-record" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Subscription Record</span></h3><pre><code class="makeup erlang" translate="no"><span class="p">-</span><span class="na">record</span><span class="p" data-group-id="0220055870-1">(</span><span class="ss">subscription</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0220055870-2">{</span><span class="w">
    </span><span class="ss">name</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">binary</span><span class="p" data-group-id="0220055870-3">(</span><span class="p" data-group-id="0220055870-3">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">type</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="ss">stream</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="ss">event_type</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="ss">event_pattern</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="ss">event_payload</span><span class="p">,</span><span class="w">
    </span><span class="ss">selector</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">binary</span><span class="p" data-group-id="0220055870-4">(</span><span class="p" data-group-id="0220055870-4">)</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nf">map</span><span class="p" data-group-id="0220055870-5">(</span><span class="p" data-group-id="0220055870-5">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">handler</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">pid</span><span class="p" data-group-id="0220055870-6">(</span><span class="p" data-group-id="0220055870-6">)</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nf">function</span><span class="p" data-group-id="0220055870-7">(</span><span class="p" data-group-id="0220055870-7">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">options</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">map</span><span class="p" data-group-id="0220055870-8">(</span><span class="p" data-group-id="0220055870-8">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">created_at</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">integer</span><span class="p" data-group-id="0220055870-9">(</span><span class="p" data-group-id="0220055870-9">)</span><span class="w">
</span><span class="p" data-group-id="0220055870-2">}</span><span class="p" data-group-id="0220055870-1">)</span><span class="p">.</span></code></pre><h2 id="schema-registry-storage" class="section-heading"><a href="#schema-registry-storage" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Schema Registry Storage</span></h2><h3 id="path-format-3" class="section-heading"><a href="#path-format-3" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Path Format</span></h3><pre><code class="makeup erlang" translate="no"><span class="o">?</span><span class="n">SCHEMAS_PATH</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="p" data-group-id="7902763827-1">[</span><span class="n">StoreId</span><span class="p">,</span><span class="w"> </span><span class="n">EventType</span><span class="p" data-group-id="7902763827-1">]</span><span class="w">
</span><span class="c1">%% Example: [schemas, my_store, &lt;&lt;&quot;OrderPlaced&quot;&gt;&gt;]</span></code></pre><h3 id="schema-structure" class="section-heading"><a href="#schema-structure" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Schema Structure</span></h3><pre><code class="makeup erlang" translate="no"><span class="p" data-group-id="6932435680-1">#{</span><span class="w">
    </span><span class="ss">event_type</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="6932435680-2">&lt;&lt;</span><span class="s">&quot;OrderPlaced&quot;</span><span class="p" data-group-id="6932435680-2">&gt;&gt;</span><span class="p">,</span><span class="w">
    </span><span class="ss">version</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w">
    </span><span class="ss">upcast_from</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="6932435680-3">#{</span><span class="w">
        </span><span class="mi">1</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="6932435680-4">(</span><span class="n">Data</span><span class="p" data-group-id="6932435680-4">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w"> </span><span class="k">end</span><span class="p">,</span><span class="w">
        </span><span class="mi">2</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="6932435680-5">(</span><span class="n">Data</span><span class="p" data-group-id="6932435680-5">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w"> </span><span class="k">end</span><span class="w">
    </span><span class="p" data-group-id="6932435680-3">}</span><span class="p">,</span><span class="w">
    </span><span class="ss">validator</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="6932435680-6">(</span><span class="n">Data</span><span class="p" data-group-id="6932435680-6">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="ss">ok</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p" data-group-id="6932435680-7">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="6932435680-7">}</span><span class="w"> </span><span class="k">end</span><span class="p">,</span><span class="w">
    </span><span class="ss">description</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="6932435680-8">&lt;&lt;</span><span class="s">&quot;Current order event schema&quot;</span><span class="p" data-group-id="6932435680-8">&gt;&gt;</span><span class="p">,</span><span class="w">
    </span><span class="ss">registered_at</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">1735689600000</span><span class="w">
</span><span class="p" data-group-id="6932435680-1">}</span></code></pre><h2 id="links-storage" class="section-heading"><a href="#links-storage" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Links Storage</span></h2><h3 id="path-format-4" class="section-heading"><a href="#path-format-4" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Path Format</span></h3><pre><code class="makeup erlang" translate="no"><span class="o">?</span><span class="n">LINKS_PATH</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="p" data-group-id="3306380288-1">[</span><span class="n">StoreId</span><span class="p">,</span><span class="w"> </span><span class="n">LinkName</span><span class="p" data-group-id="3306380288-1">]</span><span class="w">
</span><span class="c1">%% Example: [links, my_store, &lt;&lt;&quot;high-value-orders&quot;&gt;&gt;]</span></code></pre><h3 id="link-record" class="section-heading"><a href="#link-record" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Link Record</span></h3><pre><code class="makeup erlang" translate="no"><span class="p">-</span><span class="na">record</span><span class="p" data-group-id="7157809791-1">(</span><span class="nb">link</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7157809791-2">{</span><span class="w">
    </span><span class="ss">name</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">binary</span><span class="p" data-group-id="7157809791-3">(</span><span class="p" data-group-id="7157809791-3">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">source</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">source_spec</span><span class="p" data-group-id="7157809791-4">(</span><span class="p" data-group-id="7157809791-4">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">filter</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="7157809791-5">(</span><span class="p" data-group-id="7157809791-6">(</span><span class="nf">event</span><span class="p" data-group-id="7157809791-7">(</span><span class="p" data-group-id="7157809791-7">)</span><span class="p" data-group-id="7157809791-6">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nf">boolean</span><span class="p" data-group-id="7157809791-8">(</span><span class="p" data-group-id="7157809791-8">)</span><span class="p" data-group-id="7157809791-5">)</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="ss">undefined</span><span class="p">,</span><span class="w">
    </span><span class="ss">transform</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="7157809791-9">(</span><span class="p" data-group-id="7157809791-10">(</span><span class="nf">event</span><span class="p" data-group-id="7157809791-11">(</span><span class="p" data-group-id="7157809791-11">)</span><span class="p" data-group-id="7157809791-10">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nf">event</span><span class="p" data-group-id="7157809791-12">(</span><span class="p" data-group-id="7157809791-12">)</span><span class="p" data-group-id="7157809791-9">)</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="ss">undefined</span><span class="p">,</span><span class="w">
    </span><span class="ss">backfill</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">boolean</span><span class="p" data-group-id="7157809791-13">(</span><span class="p" data-group-id="7157809791-13">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">created_at</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">integer</span><span class="p" data-group-id="7157809791-14">(</span><span class="p" data-group-id="7157809791-14">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">status</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="ss">running</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="ss">stopped</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="ss">error</span><span class="p">,</span><span class="w">
    </span><span class="ss">processed</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">non_neg_integer</span><span class="p" data-group-id="7157809791-15">(</span><span class="p" data-group-id="7157809791-15">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">last_event</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">binary</span><span class="p" data-group-id="7157809791-16">(</span><span class="p" data-group-id="7157809791-16">)</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="ss">undefined</span><span class="w">
</span><span class="p" data-group-id="7157809791-2">}</span><span class="p" data-group-id="7157809791-1">)</span><span class="p">.</span></code></pre><h2 id="cluster-replication" class="section-heading"><a href="#cluster-replication" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Cluster Replication</span></h2><h3 id="ra-consensus" class="section-heading"><a href="#ra-consensus" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Ra Consensus</span></h3><p>All writes go through Raft consensus:</p><pre><code class="makeup erlang" translate="no"><span class="w">   </span><span class="n">Write</span><span class="w"> </span><span class="n">Request</span><span class="w">
        </span><span class="err">│</span><span class="w">
        </span><span class="err">▼</span><span class="w">
   </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">
   </span><span class="err">│</span><span class="w">  </span><span class="n">Leader</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="err">◄</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">All</span><span class="w"> </span><span class="ss">writes</span><span class="w"> </span><span class="ss">go</span><span class="w"> </span><span class="ss">here</span><span class="w">
   </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┬</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">
        </span><span class="err">│</span><span class="w">
   </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┴</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┬</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">
   </span><span class="err">│</span><span class="w">         </span><span class="err">│</span><span class="w">        </span><span class="err">│</span><span class="w">
   </span><span class="err">▼</span><span class="w">         </span><span class="err">▼</span><span class="w">        </span><span class="err">▼</span><span class="w">
</span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w"> </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w"> </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">
</span><span class="err">│</span><span class="n">Follow</span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="n">Follow</span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="n">Follow</span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="mi">1</span><span class="w">   </span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w">  </span><span class="mi">2</span><span class="w">   </span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w">  </span><span class="mi">3</span><span class="w">   </span><span class="err">│</span><span class="w">
</span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w"> </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w"> </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span></code></pre><h3 id="consistency-guarantees" class="section-heading"><a href="#consistency-guarantees" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Consistency Guarantees</span></h3><table><thead><tr><th style="text-align: left;">Operation</th><th style="text-align: left;">Guarantee</th></tr></thead><tbody><tr><td style="text-align: left;">Write (append)</td><td style="text-align: left;">Strongly consistent (quorum)</td></tr><tr><td style="text-align: left;">Read</td><td style="text-align: left;">Strongly consistent (from leader)</td></tr><tr><td style="text-align: left;">Cross-stream</td><td style="text-align: left;">No transaction (best effort)</td></tr></tbody></table><h3 id="failover-behavior" class="section-heading"><a href="#failover-behavior" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Failover Behavior</span></h3><ol><li>Leader fails</li><li>Ra elects new leader (typically &lt; 1 second)</li><li>Writes resume on new leader</li><li>In-flight writes may need retry</li></ol><h2 id="storage-operations" class="section-heading"><a href="#storage-operations" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Storage Operations</span></h2><h3 id="writing-events" class="section-heading"><a href="#writing-events" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Writing Events</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% Append event</span><span class="w">
</span><span class="n">PaddedVersion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">pad_version</span><span class="p" data-group-id="7060313281-1">(</span><span class="n">Version</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="n">VERSION_PADDING</span><span class="p" data-group-id="7060313281-1">)</span><span class="p">,</span><span class="w">
</span><span class="n">Path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="7060313281-2">[</span><span class="ss">streams</span><span class="p">,</span><span class="w"> </span><span class="n">StreamId</span><span class="p">,</span><span class="w"> </span><span class="n">PaddedVersion</span><span class="p" data-group-id="7060313281-2">]</span><span class="p">,</span><span class="w">
</span><span class="nc">khepri</span><span class="p">:</span><span class="nf">put</span><span class="p" data-group-id="7060313281-3">(</span><span class="n">StoreId</span><span class="p">,</span><span class="w"> </span><span class="n">Path</span><span class="p">,</span><span class="w"> </span><span class="n">Event</span><span class="p" data-group-id="7060313281-3">)</span><span class="p">.</span></code></pre><h3 id="reading-events-1" class="section-heading"><a href="#reading-events-1" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Reading Events</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% Read specific version</span><span class="w">
</span><span class="p" data-group-id="1115809177-1">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Event</span><span class="p" data-group-id="1115809177-1">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">khepri</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="1115809177-2">(</span><span class="n">StoreId</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1115809177-3">[</span><span class="ss">streams</span><span class="p">,</span><span class="w"> </span><span class="n">StreamId</span><span class="p">,</span><span class="w"> </span><span class="n">PaddedVersion</span><span class="p" data-group-id="1115809177-3">]</span><span class="p" data-group-id="1115809177-2">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Read all events in stream</span><span class="w">
</span><span class="n">Pattern</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="1115809177-4">[</span><span class="ss">streams</span><span class="p">,</span><span class="w"> </span><span class="n">StreamId</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="n">KHEPRI_WILDCARD_STAR</span><span class="p" data-group-id="1115809177-4">]</span><span class="p">,</span><span class="w">
</span><span class="p" data-group-id="1115809177-5">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">EventsMap</span><span class="p" data-group-id="1115809177-5">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">khepri</span><span class="p">:</span><span class="nf">get_many</span><span class="p" data-group-id="1115809177-6">(</span><span class="n">StoreId</span><span class="p">,</span><span class="w"> </span><span class="n">Pattern</span><span class="p" data-group-id="1115809177-6">)</span><span class="p">.</span></code></pre><h3 id="deleting-events-scavenging" class="section-heading"><a href="#deleting-events-scavenging" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Deleting Events (Scavenging)</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% Delete individual event</span><span class="w">
</span><span class="nc">khepri</span><span class="p">:</span><span class="nf">delete</span><span class="p" data-group-id="6405780047-1">(</span><span class="n">StoreId</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6405780047-2">[</span><span class="ss">streams</span><span class="p">,</span><span class="w"> </span><span class="n">StreamId</span><span class="p">,</span><span class="w"> </span><span class="n">PaddedVersion</span><span class="p" data-group-id="6405780047-2">]</span><span class="p" data-group-id="6405780047-1">)</span><span class="p">.</span></code></pre><h3 id="listing-streams" class="section-heading"><a href="#listing-streams" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Listing Streams</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% Get all stream IDs</span><span class="w">
</span><span class="n">Pattern</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="6487863938-1">[</span><span class="ss">streams</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="n">KHEPRI_WILDCARD_STAR</span><span class="p" data-group-id="6487863938-1">]</span><span class="p">,</span><span class="w">
</span><span class="p" data-group-id="6487863938-2">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">StreamNodes</span><span class="p" data-group-id="6487863938-2">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">khepri</span><span class="p">:</span><span class="nf">get_many</span><span class="p" data-group-id="6487863938-3">(</span><span class="n">StoreId</span><span class="p">,</span><span class="w"> </span><span class="n">Pattern</span><span class="p" data-group-id="6487863938-3">)</span><span class="p">,</span><span class="w">
</span><span class="n">StreamIds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">keys</span><span class="p" data-group-id="6487863938-4">(</span><span class="n">StreamNodes</span><span class="p" data-group-id="6487863938-4">)</span><span class="p">.</span></code></pre><h2 id="memory-considerations" class="section-heading"><a href="#memory-considerations" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Memory Considerations</span></h2><h3 id="khepri-in-memory" class="section-heading"><a href="#khepri-in-memory" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Khepri In-Memory</span></h3><p>Khepri keeps data in memory for fast access:</p><ul><li>All paths and values are in memory</li><li>Raft log is also in memory (up to snapshot interval)</li><li>Consider total event size when planning capacity</li></ul><h3 id="memory-estimation" class="section-heading"><a href="#memory-estimation" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Memory Estimation</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% Rough estimate per event</span><span class="w">
</span><span class="n">EventMemory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">byte_size</span><span class="p" data-group-id="7390209097-1">(</span><span class="nf">term_to_binary</span><span class="p" data-group-id="7390209097-2">(</span><span class="n">Event</span><span class="p" data-group-id="7390209097-2">)</span><span class="p" data-group-id="7390209097-1">)</span><span class="p">,</span><span class="w">
</span><span class="n">TotalEvents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1000000</span><span class="p">,</span><span class="w">
</span><span class="n">ApproxMemory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EventMemory</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">TotalEvents</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1.5</span><span class="p">,</span><span class="w">  </span><span class="c1">%% 1.5x for overhead</span></code></pre><h3 id="reducing-memory" class="section-heading"><a href="#reducing-memory" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Reducing Memory</span></h3><ol><li><strong>Scavenging</strong>: Remove old events</li><li><strong>Snapshots</strong>: Enable state recovery without all events</li><li><strong>Archival</strong>: Move to cold storage before scavenging</li></ol><h2 id="disk-persistence" class="section-heading"><a href="#disk-persistence" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Disk Persistence</span></h2><h3 id="ra-snapshots" class="section-heading"><a href="#ra-snapshots" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Ra Snapshots</span></h3><p>Ra periodically snapshots the Raft log to disk:</p><pre><code class="makeup erlang" translate="no"><span class="c1">%% Default location</span><span class="w">
</span><span class="n">DataDir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">application</span><span class="p">:</span><span class="nf">get_env</span><span class="p" data-group-id="3268934402-1">(</span><span class="ss">ra</span><span class="p">,</span><span class="w"> </span><span class="ss">data_dir</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;ra_data&quot;</span><span class="p" data-group-id="3268934402-1">)</span><span class="p">,</span><span class="w">
</span><span class="c1">%% Store-specific subdirectory</span><span class="w">
</span><span class="n">StoreDir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">filename</span><span class="p">:</span><span class="nf">join</span><span class="p" data-group-id="3268934402-2">(</span><span class="n">DataDir</span><span class="p">,</span><span class="w"> </span><span class="nf">atom_to_list</span><span class="p" data-group-id="3268934402-3">(</span><span class="n">StoreId</span><span class="p" data-group-id="3268934402-3">)</span><span class="p" data-group-id="3268934402-2">)</span><span class="p">.</span></code></pre><h3 id="snapshot-interval" class="section-heading"><a href="#snapshot-interval" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Snapshot Interval</span></h3><p>Configure via Ra settings:</p><pre><code class="makeup erlang" translate="no"><span class="c1">%% In sys.config</span><span class="w">
</span><span class="p" data-group-id="5776724652-1">{</span><span class="ss">ra</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5776724652-2">[</span><span class="w">
    </span><span class="p" data-group-id="5776724652-3">{</span><span class="ss">segment_max_entries</span><span class="p">,</span><span class="w"> </span><span class="mi">65536</span><span class="p" data-group-id="5776724652-3">}</span><span class="p">,</span><span class="w">    </span><span class="c1">%% Entries per segment</span><span class="w">
    </span><span class="p" data-group-id="5776724652-4">{</span><span class="ss">wal_max_size_bytes</span><span class="p">,</span><span class="w"> </span><span class="mi">134217728</span><span class="p" data-group-id="5776724652-4">}</span><span class="w">  </span><span class="c1">%% 128MB WAL size</span><span class="w">
</span><span class="p" data-group-id="5776724652-2">]</span><span class="p" data-group-id="5776724652-1">}</span></code></pre><h2 id="querying-patterns" class="section-heading"><a href="#querying-patterns" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Querying Patterns</span></h2><h3 id="prefix-queries" class="section-heading"><a href="#prefix-queries" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Prefix Queries</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% All events for a stream</span><span class="w">
</span><span class="p" data-group-id="5369101054-1">[</span><span class="ss">streams</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5369101054-2">&lt;&lt;</span><span class="s">&quot;orders-123&quot;</span><span class="p" data-group-id="5369101054-2">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="n">KHEPRI_WILDCARD_STAR</span><span class="p" data-group-id="5369101054-1">]</span><span class="w">

</span><span class="c1">%% All snapshots for a stream</span><span class="w">
</span><span class="p" data-group-id="5369101054-3">[</span><span class="ss">snapshots</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5369101054-4">&lt;&lt;</span><span class="s">&quot;orders-123&quot;</span><span class="p" data-group-id="5369101054-4">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="n">KHEPRI_WILDCARD_STAR</span><span class="p" data-group-id="5369101054-3">]</span></code></pre><h3 id="existence-checks" class="section-heading"><a href="#existence-checks" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Existence Checks</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% Check if stream exists</span><span class="w">
</span><span class="k">case</span><span class="w"> </span><span class="nc">khepri</span><span class="p">:</span><span class="nf">exists</span><span class="p" data-group-id="5444971239-1">(</span><span class="n">StoreId</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5444971239-2">[</span><span class="ss">streams</span><span class="p">,</span><span class="w"> </span><span class="n">StreamId</span><span class="p" data-group-id="5444971239-2">]</span><span class="p" data-group-id="5444971239-1">)</span><span class="w"> </span><span class="k">of</span><span class="w">
    </span><span class="ss">true</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="ss">stream_exists</span><span class="p">;</span><span class="w">
    </span><span class="ss">false</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="ss">no_stream</span><span class="w">
</span><span class="k">end</span><span class="p">.</span></code></pre><h3 id="conditional-updates" class="section-heading"><a href="#conditional-updates" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Conditional Updates</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% Optimistic concurrency via expected version</span><span class="w">
</span><span class="k">case</span><span class="w"> </span><span class="nc">khepri</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="6874869665-1">(</span><span class="n">StoreId</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6874869665-2">[</span><span class="ss">streams</span><span class="p">,</span><span class="w"> </span><span class="n">StreamId</span><span class="p">,</span><span class="w"> </span><span class="n">PaddedExpectedVersion</span><span class="p" data-group-id="6874869665-2">]</span><span class="p" data-group-id="6874869665-1">)</span><span class="w"> </span><span class="k">of</span><span class="w">
    </span><span class="p" data-group-id="6874869665-3">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="p" data-group-id="6874869665-3">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="c1">%% Version exists, write next</span><span class="w">
        </span><span class="nc">khepri</span><span class="p">:</span><span class="nf">put</span><span class="p" data-group-id="6874869665-4">(</span><span class="n">StoreId</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6874869665-5">[</span><span class="ss">streams</span><span class="p">,</span><span class="w"> </span><span class="n">StreamId</span><span class="p">,</span><span class="w"> </span><span class="n">PaddedNextVersion</span><span class="p" data-group-id="6874869665-5">]</span><span class="p">,</span><span class="w"> </span><span class="n">NewEvent</span><span class="p" data-group-id="6874869665-4">)</span><span class="p">;</span><span class="w">
    </span><span class="p" data-group-id="6874869665-6">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6874869665-7">{</span><span class="ss">khepri</span><span class="p">,</span><span class="w"> </span><span class="ss">node_not_found</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="p" data-group-id="6874869665-7">}</span><span class="p" data-group-id="6874869665-6">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="p" data-group-id="6874869665-8">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">wrong_expected_version</span><span class="p" data-group-id="6874869665-8">}</span><span class="w">
</span><span class="k">end</span><span class="p">.</span></code></pre><h2 id="performance-tips" class="section-heading"><a href="#performance-tips" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Performance Tips</span></h2><h3 id="1-batch-writes" class="section-heading"><a href="#1-batch-writes" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">1. Batch Writes</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% Write multiple events in single Ra command</span><span class="w">
</span><span class="n">Events</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="1565105911-1">[</span><span class="n">Event1</span><span class="p">,</span><span class="w"> </span><span class="n">Event2</span><span class="p">,</span><span class="w"> </span><span class="n">Event3</span><span class="p" data-group-id="1565105911-1">]</span><span class="p">,</span><span class="w">
</span><span class="nc">khepri</span><span class="p">:</span><span class="nf">transaction</span><span class="p" data-group-id="1565105911-2">(</span><span class="n">StoreId</span><span class="p">,</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="1565105911-3">(</span><span class="p" data-group-id="1565105911-3">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">lists</span><span class="p">:</span><span class="nf">foreach</span><span class="p" data-group-id="1565105911-4">(</span><span class="nf">fun</span><span class="p" data-group-id="1565105911-5">(</span><span class="n">E</span><span class="p" data-group-id="1565105911-5">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="nc">khepri</span><span class="p">:</span><span class="nf">put</span><span class="p" data-group-id="1565105911-6">(</span><span class="p" data-group-id="1565105911-7">[</span><span class="ss">streams</span><span class="p">,</span><span class="w"> </span><span class="n">StreamId</span><span class="p">,</span><span class="w"> </span><span class="nf">pad_version</span><span class="p" data-group-id="1565105911-8">(</span><span class="n">E</span><span class="o">#</span><span class="ss">event</span><span class="p">.</span><span class="ss">version</span><span class="p" data-group-id="1565105911-8">)</span><span class="p" data-group-id="1565105911-7">]</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="p" data-group-id="1565105911-6">)</span><span class="w">
    </span><span class="k">end</span><span class="p">,</span><span class="w"> </span><span class="n">Events</span><span class="p" data-group-id="1565105911-4">)</span><span class="w">
</span><span class="k">end</span><span class="p" data-group-id="1565105911-2">)</span><span class="p">.</span></code></pre><h3 id="2-use-snapshots" class="section-heading"><a href="#2-use-snapshots" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">2. Use Snapshots</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% Avoid replaying thousands of events</span><span class="w">
</span><span class="p" data-group-id="5301632107-1">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Snapshot</span><span class="p" data-group-id="5301632107-1">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">load_latest_snapshot</span><span class="p" data-group-id="5301632107-2">(</span><span class="n">StoreId</span><span class="p">,</span><span class="w"> </span><span class="n">StreamId</span><span class="p" data-group-id="5301632107-2">)</span><span class="p">,</span><span class="w">
</span><span class="p" data-group-id="5301632107-3">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">NewEvents</span><span class="p" data-group-id="5301632107-3">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">read_events_since</span><span class="p" data-group-id="5301632107-4">(</span><span class="n">StoreId</span><span class="p">,</span><span class="w"> </span><span class="n">StreamId</span><span class="p">,</span><span class="w"> </span><span class="n">Snapshot</span><span class="o">#</span><span class="ss">snapshot</span><span class="p">.</span><span class="ss">version</span><span class="p" data-group-id="5301632107-4">)</span><span class="p">,</span><span class="w">
</span><span class="n">State</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">apply_events</span><span class="p" data-group-id="5301632107-5">(</span><span class="n">Snapshot</span><span class="o">#</span><span class="ss">snapshot</span><span class="p">.</span><span class="ss">state</span><span class="p">,</span><span class="w"> </span><span class="n">NewEvents</span><span class="p" data-group-id="5301632107-5">)</span><span class="p">.</span></code></pre><h3 id="3-monitor-memory" class="section-heading"><a href="#3-monitor-memory" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">3. Monitor Memory</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% Check Khepri memory usage</span><span class="w">
</span><span class="n">KhepriInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">khepri</span><span class="p">:</span><span class="nf">info</span><span class="p" data-group-id="8701835505-1">(</span><span class="n">StoreId</span><span class="p" data-group-id="8701835505-1">)</span><span class="p">,</span><span class="w">
</span><span class="n">MemoryUsed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">proplists</span><span class="p">:</span><span class="nf">get_value</span><span class="p" data-group-id="8701835505-2">(</span><span class="nb">memory</span><span class="p">,</span><span class="w"> </span><span class="n">KhepriInfo</span><span class="p" data-group-id="8701835505-2">)</span><span class="p">.</span></code></pre><h2 id="troubleshooting" class="section-heading"><a href="#troubleshooting" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Troubleshooting</span></h2><h3 id="common-issues" class="section-heading"><a href="#common-issues" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Common Issues</span></h3><table><thead><tr><th style="text-align: left;">Issue</th><th style="text-align: left;">Cause</th><th style="text-align: left;">Resolution</th></tr></thead><tbody><tr><td style="text-align: left;">Slow writes</td><td style="text-align: left;">No quorum</td><td style="text-align: left;">Check cluster health</td></tr><tr><td style="text-align: left;">High memory</td><td style="text-align: left;">Too many events</td><td style="text-align: left;">Enable scavenging</td></tr><tr><td style="text-align: left;">Stale reads</td><td style="text-align: left;">Reading during partition</td><td style="text-align: left;">Wait for partition heal</td></tr></tbody></table><h3 id="diagnostic-commands" class="section-heading"><a href="#diagnostic-commands" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Diagnostic Commands</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% Cluster status</span><span class="w">
</span><span class="nc">ra</span><span class="p">:</span><span class="nf">members</span><span class="p" data-group-id="8773099029-1">(</span><span class="n">StoreId</span><span class="p" data-group-id="8773099029-1">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Leader info</span><span class="w">
</span><span class="nc">khepri</span><span class="p">:</span><span class="nf">get_leader</span><span class="p" data-group-id="8773099029-2">(</span><span class="n">StoreId</span><span class="p" data-group-id="8773099029-2">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Store statistics</span><span class="w">
</span><span class="nc">khepri</span><span class="p">:</span><span class="nf">info</span><span class="p" data-group-id="8773099029-3">(</span><span class="n">StoreId</span><span class="p" data-group-id="8773099029-3">)</span><span class="p">.</span></code></pre><h2 id="see-also" class="section-heading"><a href="#see-also" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">See Also</span></h2><ul><li><a href="temporal_queries.html">Temporal Queries</a> - Time-based event retrieval</li><li><a href="scavenging.html">Scavenging</a> - Event lifecycle management</li><li><a href="memory_pressure.html">Memory Pressure</a> - Memory monitoring</li></ul>

</div>

<div class="bottom-actions" id="bottom-actions">
  <div class="bottom-actions-item">

      <a href="memory_pressure.html" class="bottom-actions-button" rel="prev">
        <span class="subheader">
          ← Previous Page
        </span>
        <span class="title">
Memory Pressure
        </span>
      </a>

  </div>
  <div class="bottom-actions-item">

      <a href="cluster_consistency.html" class="bottom-actions-button" rel="next">
        <span class="subheader">
          Next Page →
        </span>
        <span class="title">
Cluster Consistency
        </span>
      </a>

  </div>
</div>
    <footer class="footer">
      <p>

          <span class="line">
            <a href="https://hex.pm/packages/reckon_db/1.2.0" class="footer-hex-package">Hex Package</a>

            <a href="https://preview.hex.pm/preview/reckon_db/1.2.0">Hex Preview</a>

              (<a href="https://preview.hex.pm/preview/reckon_db/1.2.0/show/guides/storage_internals.md">current file</a>)

          </span>

        <span class="line">
          <button class="a-main footer-button display-quick-switch" title="Search HexDocs packages">
            Search HexDocs
          </button>

            <a href="reckon_db.epub" title="ePub version">
              Download ePub version
            </a>

        </span>
      </p>

      <p class="built-using">
        Built using
        <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.38.2) for the

          <a href="https://erlang.org" title="Erlang" target="_blank" translate="no">Erlang programming language</a>

      </p>

    </footer>
  </div>
</main>
</div>

  </body>
</html>
