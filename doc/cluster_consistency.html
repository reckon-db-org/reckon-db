<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.38.2">
    <meta name="project" content="reckon_db v1.2.0">


    <title>Cluster Consistency â€” reckon_db v1.2.0</title>

    <link rel="stylesheet" href="dist/html-erlang-DQDXQC7W.css" />

    <script defer src="dist/sidebar_items-36A01327.js"></script>
    <script defer src="docs_config.js"></script>
    <script defer src="dist/html-DPJLHKSM.js"></script>

  </head>
  <body>
    <script>(()=>{var t="ex_doc:settings",e="dark";var o="dark",s="light";var E="sidebar_state",n="closed";var r="sidebar_width";var a="sidebar-open";var i=new URLSearchParams(window.location.search),S=i.get("theme")||JSON.parse(localStorage.getItem(t)||"{}").theme;(S===o||S!==s&&window.matchMedia("(prefers-color-scheme: dark)").matches)&&document.body.classList.add(e);var d=sessionStorage.getItem(E),A=d!==n&&!window.matchMedia(`screen and (max-width: ${768}px)`).matches;document.body.classList.toggle(a,A);var c=sessionStorage.getItem(r);c&&document.body.style.setProperty("--sidebarWidth",`${c}px`);var p=/(Macintosh|iPhone|iPad|iPod)/.test(window.navigator.userAgent);document.documentElement.classList.toggle("apple-os",p);})();
</script>

<div class="body-wrapper">

<button id="sidebar-menu" class="sidebar-button sidebar-toggle" aria-label="toggle sidebar" aria-controls="sidebar">
  <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
</button>

<nav id="sidebar" class="sidebar">

  <div class="sidebar-header">
    <div class="sidebar-projectInfo">

      <div>
        <a href="readme.html" class="sidebar-projectName" translate="no">
reckon_db
        </a>
        <div class="sidebar-projectVersion" translate="no">
          v1.2.0
        </div>
      </div>
    </div>
    <ul id="sidebar-list-nav" class="sidebar-list-nav" role="tablist" data-extras=""></ul>
  </div>
</nav>

<output role="status" id="toast"></output>

<main class="content page-extra" id="main" data-type="extras">
  <div id="content" class="content-inner">
    <div class="top-search">
      <div class="search-settings">
        <form class="search-bar" action="search.html">
          <label class="search-label">
            <span class="sr-only">Search documentation of reckon_db</span>
            <input name="q" type="text" class="search-input" placeholder="Press / to search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
          </label>
          <button type="submit" class="search-button" aria-label="Submit Search" tabindex="-1">
            <i class="ri-search-2-line ri-lg" aria-hidden="true"></i>
          </button>
          <button type="button" tabindex="-1" class="search-close-button" aria-hidden="true">
            <i class="ri-close-line ri-lg" title="Cancel search"></i>
          </button>
        </form>
        <div class="autocomplete">
        </div>
        <button class="icon-settings display-settings">
          <i class="ri-settings-3-line"></i>
          <span class="sr-only">Settings</span>
        </button>
      </div>
    </div>

<div id="top-content">
  <div class="heading-with-actions top-heading">
    <h1>Cluster Consistency &amp; Split-Brain Prevention</h1>


      <a href="https://github.com/reckon-db-org/reckon-db/blob/v1.2.0/guides/cluster_consistency.md#L1" title="View Source" class="icon-action" rel="help">
        <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        <span class="sr-only">View Source</span>
      </a>

  </div>


<p>This guide covers reckon-db's cluster consistency mechanisms, split-brain detection, active health probing, and quorum management. These systems work together to ensure data integrity in distributed deployments.</p><h2 id="overview" class="section-heading"><a href="#overview" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Overview</span></h2><p>Distributed event stores face fundamental challenges from the CAP theorem. reckon-db prioritizes <strong>Consistency</strong> and <strong>Partition tolerance</strong>, using Raft consensus via Khepri/Ra. However, network partitions can still cause split-brain scenarios that require detection and mitigation.</p><h2 id="architecture" class="section-heading"><a href="#architecture" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Architecture</span></h2><p><img src="../assets/consistency_checker.svg" alt="Consistency Checker Architecture"/></p><h2 id="the-split-brain-problem" class="section-heading"><a href="#the-split-brain-problem" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">The Split-Brain Problem</span></h2><h3 id="what-is-split-brain" class="section-heading"><a href="#what-is-split-brain" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">What is Split-Brain?</span></h3><p>Split-brain occurs when network partitions cause nodes to form independent clusters, each believing it is the authoritative source. This can lead to:</p><ul><li><strong>Divergent event streams</strong> - Different events written to the same stream on different partitions</li><li><strong>Lost events</strong> - Events written to minority partition may be discarded on merge</li><li><strong>Inconsistent state</strong> - Projections built from divergent streams</li></ul><p><img src="../assets/split_brain_detection.svg" alt="Split-Brain Detection"/></p><h3 id="how-reckon-db-prevents-split-brain" class="section-heading"><a href="#how-reckon-db-prevents-split-brain" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">How reckon-db Prevents Split-Brain</span></h3><ol><li><strong>Raft Consensus</strong> - Khepri/Ra requires quorum for writes</li><li><strong>Deterministic Coordinator</strong> - Lowest node name becomes cluster coordinator</li><li><strong>Active Detection</strong> - Consistency checker identifies partition scenarios</li><li><strong>Health Probing</strong> - Fast detection of node failures</li></ol><h2 id="consistency-checker" class="section-heading"><a href="#consistency-checker" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Consistency Checker</span></h2><p>The <code class="inline">reckon_db_consistency_checker</code> module provides continuous cluster health verification.</p><h3 id="starting-the-checker" class="section-heading"><a href="#starting-the-checker" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Starting the Checker</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% Started automatically with store in cluster mode</span><span class="w">
</span><span class="c1">%% Or manually configure check interval (default: 5000ms)</span><span class="w">
</span><span class="nc">application</span><span class="p">:</span><span class="nf">set_env</span><span class="p" data-group-id="6687773025-1">(</span><span class="ss">reckon_db</span><span class="p">,</span><span class="w"> </span><span class="ss">consistency_check_interval</span><span class="p">,</span><span class="w"> </span><span class="mi">3000</span><span class="p" data-group-id="6687773025-1">)</span><span class="p">.</span></code></pre><h3 id="consistency-status-levels" class="section-heading"><a href="#consistency-status-levels" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Consistency Status Levels</span></h3><table><thead><tr><th style="text-align: left;">Status</th><th style="text-align: left;">Description</th><th style="text-align: left;">Action Required</th></tr></thead><tbody><tr><td style="text-align: left;"><code class="inline">healthy</code></td><td style="text-align: left;">All checks passing, full consensus</td><td style="text-align: left;">None</td></tr><tr><td style="text-align: left;"><code class="inline">degraded</code></td><td style="text-align: left;">Warnings present, but operational</td><td style="text-align: left;">Investigate</td></tr><tr><td style="text-align: left;"><code class="inline">split_brain</code></td><td style="text-align: left;">Nodes disagree on membership/leader</td><td style="text-align: left;">Critical - resolve partition</td></tr><tr><td style="text-align: left;"><code class="inline">no_quorum</code></td><td style="text-align: left;">Insufficient nodes for operations</td><td style="text-align: left;">Critical - restore nodes</td></tr></tbody></table><h3 id="forcing-immediate-check" class="section-heading"><a href="#forcing-immediate-check" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Forcing Immediate Check</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% Force check and get result</span><span class="w">
</span><span class="n">Result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">reckon_db_consistency_checker</span><span class="p">:</span><span class="nf">check_now</span><span class="p" data-group-id="3200331185-1">(</span><span class="ss">my_store</span><span class="p" data-group-id="3200331185-1">)</span><span class="p">,</span><span class="w">
</span><span class="c1">%% #{status =&gt; healthy,</span><span class="w">
</span><span class="c1">%%   checks =&gt; #{membership =&gt; ..., leader =&gt; ..., raft =&gt; ..., quorum =&gt; ...},</span><span class="w">
</span><span class="c1">%%   timestamp =&gt; 1703000000000,</span><span class="w">
</span><span class="c1">%%   duration_us =&gt; 1234}</span></code></pre><h3 id="registering-status-callbacks" class="section-heading"><a href="#registering-status-callbacks" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Registering Status Callbacks</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% Get notified when status changes</span><span class="w">
</span><span class="n">CallbackRef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">reckon_db_consistency_checker</span><span class="p">:</span><span class="nf">on_status_change</span><span class="p" data-group-id="7616063579-1">(</span><span class="ss">my_store</span><span class="p">,</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="7616063579-2">(</span><span class="n">Status</span><span class="p" data-group-id="7616063579-2">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="n">Status</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="ss">healthy</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="nc">logger</span><span class="p">:</span><span class="nf">info</span><span class="p" data-group-id="7616063579-3">(</span><span class="s">&quot;Cluster health restored&quot;</span><span class="p" data-group-id="7616063579-3">)</span><span class="p">;</span><span class="w">
        </span><span class="ss">degraded</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="nc">logger</span><span class="p">:</span><span class="nf">warning</span><span class="p" data-group-id="7616063579-4">(</span><span class="s">&quot;Cluster degraded - investigate&quot;</span><span class="p" data-group-id="7616063579-4">)</span><span class="p">,</span><span class="w">
            </span><span class="nf">alert_ops_team</span><span class="p" data-group-id="7616063579-5">(</span><span class="ss">degraded</span><span class="p" data-group-id="7616063579-5">)</span><span class="p">;</span><span class="w">
        </span><span class="ss">split_brain</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="nc">logger</span><span class="p">:</span><span class="nf">error</span><span class="p" data-group-id="7616063579-6">(</span><span class="s">&quot;SPLIT-BRAIN DETECTED!&quot;</span><span class="p" data-group-id="7616063579-6">)</span><span class="p">,</span><span class="w">
            </span><span class="nf">emergency_alert</span><span class="p" data-group-id="7616063579-7">(</span><span class="ss">split_brain</span><span class="p" data-group-id="7616063579-7">)</span><span class="p">,</span><span class="w">
            </span><span class="nf">pause_writes</span><span class="p" data-group-id="7616063579-8">(</span><span class="p" data-group-id="7616063579-8">)</span><span class="p">;</span><span class="w">
        </span><span class="ss">no_quorum</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="nc">logger</span><span class="p">:</span><span class="nf">error</span><span class="p" data-group-id="7616063579-9">(</span><span class="s">&quot;Quorum lost - operations unavailable&quot;</span><span class="p" data-group-id="7616063579-9">)</span><span class="p">,</span><span class="w">
            </span><span class="nf">emergency_alert</span><span class="p" data-group-id="7616063579-10">(</span><span class="ss">no_quorum</span><span class="p" data-group-id="7616063579-10">)</span><span class="w">
    </span><span class="k">end</span><span class="w">
</span><span class="k">end</span><span class="p" data-group-id="7616063579-1">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Remove callback when done</span><span class="w">
</span><span class="nc">reckon_db_consistency_checker</span><span class="p">:</span><span class="nf">remove_callback</span><span class="p" data-group-id="7616063579-11">(</span><span class="ss">my_store</span><span class="p">,</span><span class="w"> </span><span class="n">CallbackRef</span><span class="p" data-group-id="7616063579-11">)</span><span class="p">.</span></code></pre><h2 id="verification-checks" class="section-heading"><a href="#verification-checks" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Verification Checks</span></h2><h3 id="1-membership-consensus" class="section-heading"><a href="#1-membership-consensus" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">1. Membership Consensus</span></h3><p>Verifies all nodes agree on cluster membership.</p><pre><code class="makeup erlang" translate="no"><span class="p" data-group-id="9089336668-1">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Result</span><span class="p" data-group-id="9089336668-1">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">reckon_db_consistency_checker</span><span class="p">:</span><span class="nf">verify_membership_consensus</span><span class="p" data-group-id="9089336668-2">(</span><span class="ss">my_store</span><span class="p" data-group-id="9089336668-2">)</span><span class="p">.</span><span class="w">
</span><span class="c1">%% #{status =&gt; consensus,</span><span class="w">
</span><span class="c1">%%   nodes_checked =&gt; 3,</span><span class="w">
</span><span class="c1">%%   nodes_responded =&gt; 3,</span><span class="w">
</span><span class="c1">%%   failed_nodes =&gt; [],</span><span class="w">
</span><span class="c1">%%   consistent_view =&gt; [{my_store, &#39;node1@host&#39;}, ...]}</span><span class="w">

</span><span class="c1">%% Or if split-brain detected:</span><span class="w">
</span><span class="c1">%% #{status =&gt; split_brain,</span><span class="w">
</span><span class="c1">%%   conflicting_views =&gt; 2,</span><span class="w">
</span><span class="c1">%%   views =&gt; #{&#39;node1@host&#39; =&gt; [...], &#39;node2@host&#39; =&gt; [...]}}</span></code></pre><h3 id="2-leader-consensus" class="section-heading"><a href="#2-leader-consensus" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">2. Leader Consensus</span></h3><p>Verifies all nodes agree on the current Raft leader.</p><pre><code class="makeup erlang" translate="no"><span class="p" data-group-id="4273194651-1">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Result</span><span class="p" data-group-id="4273194651-1">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">reckon_db_consistency_checker</span><span class="p">:</span><span class="nf">verify_leader_consensus</span><span class="p" data-group-id="4273194651-2">(</span><span class="ss">my_store</span><span class="p" data-group-id="4273194651-2">)</span><span class="p">.</span><span class="w">
</span><span class="c1">%% #{status =&gt; consensus,</span><span class="w">
</span><span class="c1">%%   leader =&gt; &#39;node1@host&#39;,</span><span class="w">
</span><span class="c1">%%   nodes_checked =&gt; 3,</span><span class="w">
</span><span class="c1">%%   nodes_responded =&gt; 3}</span><span class="w">

</span><span class="c1">%% Or if disagreement:</span><span class="w">
</span><span class="c1">%% #{status =&gt; no_consensus,</span><span class="w">
</span><span class="c1">%%   leaders_reported =&gt; [&#39;node1@host&#39;, &#39;node2@host&#39;]}</span></code></pre><h3 id="3-raft-log-consistency" class="section-heading"><a href="#3-raft-log-consistency" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">3. Raft Log Consistency</span></h3><p>Verifies follower nodes have consistent Raft log state.</p><pre><code class="makeup erlang" translate="no"><span class="p" data-group-id="6805009078-1">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Result</span><span class="p" data-group-id="6805009078-1">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">reckon_db_consistency_checker</span><span class="p">:</span><span class="nf">verify_raft_consistency</span><span class="p" data-group-id="6805009078-2">(</span><span class="ss">my_store</span><span class="p" data-group-id="6805009078-2">)</span><span class="p">.</span><span class="w">
</span><span class="c1">%% #{status =&gt; consensus,</span><span class="w">
</span><span class="c1">%%   leader =&gt; &#39;node1@host&#39;,</span><span class="w">
</span><span class="c1">%%   terms =&gt; [5],</span><span class="w">
</span><span class="c1">%%   terms_consistent =&gt; true,</span><span class="w">
</span><span class="c1">%%   commit_index_range =&gt; {100, 102},</span><span class="w">
</span><span class="c1">%%   max_commit_lag =&gt; 2}</span></code></pre><h3 id="4-quorum-status" class="section-heading"><a href="#4-quorum-status" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">4. Quorum Status</span></h3><p>Checks if sufficient nodes are available for operations.</p><pre><code class="makeup erlang" translate="no"><span class="p" data-group-id="7885482628-1">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Result</span><span class="p" data-group-id="7885482628-1">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">reckon_db_consistency_checker</span><span class="p">:</span><span class="nf">get_quorum_status</span><span class="p" data-group-id="7885482628-2">(</span><span class="ss">my_store</span><span class="p" data-group-id="7885482628-2">)</span><span class="p">.</span><span class="w">
</span><span class="c1">%% #{has_quorum =&gt; true,</span><span class="w">
</span><span class="c1">%%   total_nodes =&gt; 3,</span><span class="w">
</span><span class="c1">%%   available_nodes =&gt; 3,</span><span class="w">
</span><span class="c1">%%   required_quorum =&gt; 2,</span><span class="w">
</span><span class="c1">%%   quorum_margin =&gt; 1,</span><span class="w">
</span><span class="c1">%%   can_lose =&gt; 1}</span></code></pre><h2 id="health-probing" class="section-heading"><a href="#health-probing" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Health Probing</span></h2><p>The <code class="inline">reckon_db_health_prober</code> module implements active health checks for faster failure detection.</p><p><img src="../assets/health_probing.svg" alt="Health Probing Flow"/></p><h3 id="why-active-probing" class="section-heading"><a href="#why-active-probing" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Why Active Probing?</span></h3><p>Passive monitoring via <a href="https://www.erlang.org/doc/apps/kernel/net_kernel.html#monitor_nodes/1"><code class="inline">net_kernel:monitor_nodes/1</code></a> can take 60+ seconds to detect failures (depending on <code class="inline">net_ticktime</code>). Active probing provides:</p><ul><li><strong>Faster detection</strong> - Configurable intervals (default: 2 seconds)</li><li><strong>Failure threshold</strong> - Avoid false positives from transient issues</li><li><strong>Recovery detection</strong> - Know when failed nodes come back</li></ul><h3 id="probe-types" class="section-heading"><a href="#probe-types" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Probe Types</span></h3><table><thead><tr><th style="text-align: left;">Type</th><th style="text-align: left;">Speed</th><th style="text-align: left;">Depth</th><th style="text-align: left;">Use Case</th></tr></thead><tbody><tr><td style="text-align: left;"><code class="inline">ping</code></td><td style="text-align: left;">Fastest</td><td style="text-align: left;">Shallow</td><td style="text-align: left;">Network connectivity only</td></tr><tr><td style="text-align: left;"><code class="inline">rpc</code></td><td style="text-align: left;">Medium</td><td style="text-align: left;">Medium</td><td style="text-align: left;">Process responsiveness</td></tr><tr><td style="text-align: left;"><code class="inline">khepri</code></td><td style="text-align: left;">Slowest</td><td style="text-align: left;">Deepest</td><td style="text-align: left;">Store health verification</td></tr></tbody></table><h3 id="configuring-the-prober" class="section-heading"><a href="#configuring-the-prober" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Configuring the Prober</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% In sys.config</span><span class="w">
</span><span class="p" data-group-id="3355595794-1">{</span><span class="ss">reckon_db</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="3355595794-2">[</span><span class="w">
    </span><span class="p" data-group-id="3355595794-3">{</span><span class="ss">health_probe_interval</span><span class="p">,</span><span class="w"> </span><span class="mi">2000</span><span class="p" data-group-id="3355595794-3">}</span><span class="p">,</span><span class="w">     </span><span class="c1">%% 2 seconds between probes</span><span class="w">
    </span><span class="p" data-group-id="3355595794-4">{</span><span class="ss">health_probe_timeout</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="p" data-group-id="3355595794-4">}</span><span class="p">,</span><span class="w">      </span><span class="c1">%% 1 second timeout per probe</span><span class="w">
    </span><span class="p" data-group-id="3355595794-5">{</span><span class="ss">health_failure_threshold</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p" data-group-id="3355595794-5">}</span><span class="p">,</span><span class="w">     </span><span class="c1">%% 3 failures before declaring failed</span><span class="w">
    </span><span class="p" data-group-id="3355595794-6">{</span><span class="ss">health_probe_type</span><span class="p">,</span><span class="w"> </span><span class="ss">rpc</span><span class="p" data-group-id="3355595794-6">}</span><span class="w">           </span><span class="c1">%% rpc probe type</span><span class="w">
</span><span class="p" data-group-id="3355595794-2">]</span><span class="p" data-group-id="3355595794-1">}</span><span class="w">

</span><span class="c1">%% Or dynamically</span><span class="w">
</span><span class="nc">reckon_db_health_prober</span><span class="p">:</span><span class="nf">configure</span><span class="p" data-group-id="3355595794-7">(</span><span class="ss">my_store</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="3355595794-8">#{</span><span class="w">
    </span><span class="ss">probe_interval</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span><span class="w">
    </span><span class="ss">failure_threshold</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">2</span><span class="w">
</span><span class="p" data-group-id="3355595794-8">}</span><span class="p" data-group-id="3355595794-7">)</span><span class="p">.</span></code></pre><h3 id="node-status" class="section-heading"><a href="#node-status" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Node Status</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% Check specific node</span><span class="w">
</span><span class="p" data-group-id="5227934901-1">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Status</span><span class="p" data-group-id="5227934901-1">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">reckon_db_health_prober</span><span class="p">:</span><span class="nf">get_node_status</span><span class="p" data-group-id="5227934901-2">(</span><span class="ss">my_store</span><span class="p">,</span><span class="w"> </span><span class="ss">&#39;node2@host&#39;</span><span class="p" data-group-id="5227934901-2">)</span><span class="p">.</span><span class="w">
</span><span class="c1">%% healthy | suspect | failed | unknown</span><span class="w">

</span><span class="c1">%% Check all nodes</span><span class="w">
</span><span class="n">AllStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">reckon_db_health_prober</span><span class="p">:</span><span class="nf">get_all_status</span><span class="p" data-group-id="5227934901-3">(</span><span class="ss">my_store</span><span class="p" data-group-id="5227934901-3">)</span><span class="p">.</span><span class="w">
</span><span class="c1">%% #{&#39;node2@host&#39; =&gt; healthy, &#39;node3@host&#39; =&gt; suspect}</span></code></pre><h3 id="failure-and-recovery-callbacks" class="section-heading"><a href="#failure-and-recovery-callbacks" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Failure and Recovery Callbacks</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% Get notified when nodes fail</span><span class="w">
</span><span class="n">FailedRef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">reckon_db_health_prober</span><span class="p">:</span><span class="nf">on_node_failed</span><span class="p" data-group-id="2355809342-1">(</span><span class="ss">my_store</span><span class="p">,</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="2355809342-2">(</span><span class="n">Node</span><span class="p" data-group-id="2355809342-2">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">logger</span><span class="p">:</span><span class="nf">error</span><span class="p" data-group-id="2355809342-3">(</span><span class="s">&quot;Node </span><span class="si">~p</span><span class="s"> failed health checks&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2355809342-4">[</span><span class="n">Node</span><span class="p" data-group-id="2355809342-4">]</span><span class="p" data-group-id="2355809342-3">)</span><span class="p">,</span><span class="w">
    </span><span class="nf">remove_from_load_balancer</span><span class="p" data-group-id="2355809342-5">(</span><span class="n">Node</span><span class="p" data-group-id="2355809342-5">)</span><span class="w">
</span><span class="k">end</span><span class="p" data-group-id="2355809342-1">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Get notified when nodes recover</span><span class="w">
</span><span class="n">RecoveredRef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">reckon_db_health_prober</span><span class="p">:</span><span class="nf">on_node_recovered</span><span class="p" data-group-id="2355809342-6">(</span><span class="ss">my_store</span><span class="p">,</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="2355809342-7">(</span><span class="n">Node</span><span class="p" data-group-id="2355809342-7">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">logger</span><span class="p">:</span><span class="nf">info</span><span class="p" data-group-id="2355809342-8">(</span><span class="s">&quot;Node </span><span class="si">~p</span><span class="s"> recovered&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2355809342-9">[</span><span class="n">Node</span><span class="p" data-group-id="2355809342-9">]</span><span class="p" data-group-id="2355809342-8">)</span><span class="p">,</span><span class="w">
    </span><span class="nf">add_to_load_balancer</span><span class="p" data-group-id="2355809342-10">(</span><span class="n">Node</span><span class="p" data-group-id="2355809342-10">)</span><span class="w">
</span><span class="k">end</span><span class="p" data-group-id="2355809342-6">)</span><span class="p">.</span></code></pre><h2 id="quorum-management" class="section-heading"><a href="#quorum-management" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Quorum Management</span></h2><h3 id="understanding-quorum" class="section-heading"><a href="#understanding-quorum" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Understanding Quorum</span></h3><p>Raft consensus requires a <strong>majority</strong> (quorum) of nodes to agree on operations:</p><table><thead><tr><th style="text-align: left;">Cluster Size</th><th style="text-align: left;">Quorum Required</th><th style="text-align: left;">Nodes Can Fail</th></tr></thead><tbody><tr><td style="text-align: left;">1</td><td style="text-align: left;">1</td><td style="text-align: left;">0</td></tr><tr><td style="text-align: left;">2</td><td style="text-align: left;">2</td><td style="text-align: left;">0</td></tr><tr><td style="text-align: left;">3</td><td style="text-align: left;">2</td><td style="text-align: left;">1</td></tr><tr><td style="text-align: left;">4</td><td style="text-align: left;">3</td><td style="text-align: left;">1</td></tr><tr><td style="text-align: left;">5</td><td style="text-align: left;">3</td><td style="text-align: left;">2</td></tr><tr><td style="text-align: left;">7</td><td style="text-align: left;">4</td><td style="text-align: left;">3</td></tr></tbody></table><p><strong>Recommendation</strong>: Use odd-numbered clusters (3, 5, 7) for optimal fault tolerance.</p><h3 id="quorum-loss-behavior" class="section-heading"><a href="#quorum-loss-behavior" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Quorum Loss Behavior</span></h3><p>When quorum is lost:</p><ol><li><strong>Writes blocked</strong> - Cannot append events</li><li><strong>Reads may work</strong> - If local data available (stale)</li><li><strong>Subscriptions pause</strong> - No new events delivered</li></ol><pre><code class="makeup erlang" translate="no"><span class="c1">%% Check before critical operations</span><span class="w">
</span><span class="k">case</span><span class="w"> </span><span class="nc">reckon_db_consistency_checker</span><span class="p">:</span><span class="nf">get_quorum_status</span><span class="p" data-group-id="9085654810-1">(</span><span class="ss">my_store</span><span class="p" data-group-id="9085654810-1">)</span><span class="w"> </span><span class="k">of</span><span class="w">
    </span><span class="p" data-group-id="9085654810-2">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9085654810-3">#{</span><span class="ss">has_quorum</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="ss">true</span><span class="p">,</span><span class="w"> </span><span class="ss">can_lose</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">N</span><span class="p" data-group-id="9085654810-3">}</span><span class="p" data-group-id="9085654810-2">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="nc">logger</span><span class="p">:</span><span class="nf">info</span><span class="p" data-group-id="9085654810-4">(</span><span class="s">&quot;Quorum healthy, can lose </span><span class="si">~p</span><span class="s"> more nodes&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9085654810-5">[</span><span class="n">N</span><span class="p" data-group-id="9085654810-5">]</span><span class="p" data-group-id="9085654810-4">)</span><span class="p">,</span><span class="w">
        </span><span class="nf">proceed_with_operation</span><span class="p" data-group-id="9085654810-6">(</span><span class="p" data-group-id="9085654810-6">)</span><span class="p">;</span><span class="w">
    </span><span class="p" data-group-id="9085654810-7">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9085654810-8">#{</span><span class="ss">has_quorum</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="ss">false</span><span class="p" data-group-id="9085654810-8">}</span><span class="p" data-group-id="9085654810-7">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="nc">logger</span><span class="p">:</span><span class="nf">error</span><span class="p" data-group-id="9085654810-9">(</span><span class="s">&quot;No quorum - operation blocked&quot;</span><span class="p" data-group-id="9085654810-9">)</span><span class="p">,</span><span class="w">
        </span><span class="p" data-group-id="9085654810-10">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">no_quorum</span><span class="p" data-group-id="9085654810-10">}</span><span class="w">
</span><span class="k">end</span><span class="p">.</span></code></pre><h2 id="integration-patterns" class="section-heading"><a href="#integration-patterns" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Integration Patterns</span></h2><h3 id="1-startup-verification" class="section-heading"><a href="#1-startup-verification" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">1. Startup Verification</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% In application startup</span><span class="w">
</span><span class="nf">start_link</span><span class="p" data-group-id="2434132950-1">(</span><span class="p" data-group-id="2434132950-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="2434132950-2">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Pid</span><span class="p" data-group-id="2434132950-2">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">reckon_db</span><span class="p">:</span><span class="nf">start_store</span><span class="p" data-group-id="2434132950-3">(</span><span class="ss">my_store</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2434132950-4">#{</span><span class="ss">mode</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">cluster</span><span class="p" data-group-id="2434132950-4">}</span><span class="p" data-group-id="2434132950-3">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Wait for cluster health before accepting traffic</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nf">wait_for_healthy</span><span class="p" data-group-id="2434132950-5">(</span><span class="ss">my_store</span><span class="p">,</span><span class="w"> </span><span class="mi">30000</span><span class="p" data-group-id="2434132950-5">)</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="ss">ok</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="nc">logger</span><span class="p">:</span><span class="nf">info</span><span class="p" data-group-id="2434132950-6">(</span><span class="s">&quot;Store healthy, accepting traffic&quot;</span><span class="p" data-group-id="2434132950-6">)</span><span class="p">,</span><span class="w">
            </span><span class="p" data-group-id="2434132950-7">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Pid</span><span class="p" data-group-id="2434132950-7">}</span><span class="p">;</span><span class="w">
        </span><span class="p" data-group-id="2434132950-8">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="2434132950-8">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="nc">logger</span><span class="p">:</span><span class="nf">error</span><span class="p" data-group-id="2434132950-9">(</span><span class="s">&quot;Store unhealthy: </span><span class="si">~p</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2434132950-10">[</span><span class="n">Reason</span><span class="p" data-group-id="2434132950-10">]</span><span class="p" data-group-id="2434132950-9">)</span><span class="p">,</span><span class="w">
            </span><span class="p" data-group-id="2434132950-11">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">cluster_unhealthy</span><span class="p" data-group-id="2434132950-11">}</span><span class="w">
    </span><span class="k">end</span><span class="p">.</span><span class="w">

</span><span class="nf">wait_for_healthy</span><span class="p" data-group-id="2434132950-12">(</span><span class="n">StoreId</span><span class="p">,</span><span class="w"> </span><span class="n">Timeout</span><span class="p" data-group-id="2434132950-12">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">Deadline</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">erlang</span><span class="p">:</span><span class="nf">monotonic_time</span><span class="p" data-group-id="2434132950-13">(</span><span class="ss">millisecond</span><span class="p" data-group-id="2434132950-13">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Timeout</span><span class="p">,</span><span class="w">
    </span><span class="nf">wait_for_healthy_loop</span><span class="p" data-group-id="2434132950-14">(</span><span class="n">StoreId</span><span class="p">,</span><span class="w"> </span><span class="n">Deadline</span><span class="p" data-group-id="2434132950-14">)</span><span class="p">.</span><span class="w">

</span><span class="nf">wait_for_healthy_loop</span><span class="p" data-group-id="2434132950-15">(</span><span class="n">StoreId</span><span class="p">,</span><span class="w"> </span><span class="n">Deadline</span><span class="p" data-group-id="2434132950-15">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">reckon_db_consistency_checker</span><span class="p">:</span><span class="nf">get_status</span><span class="p" data-group-id="2434132950-16">(</span><span class="n">StoreId</span><span class="p" data-group-id="2434132950-16">)</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="p" data-group-id="2434132950-17">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="ss">healthy</span><span class="p" data-group-id="2434132950-17">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="ss">ok</span><span class="p">;</span><span class="w">
        </span><span class="p" data-group-id="2434132950-18">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Status</span><span class="p" data-group-id="2434132950-18">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="n">Now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">erlang</span><span class="p">:</span><span class="nf">monotonic_time</span><span class="p" data-group-id="2434132950-19">(</span><span class="ss">millisecond</span><span class="p" data-group-id="2434132950-19">)</span><span class="p">,</span><span class="w">
            </span><span class="k">case</span><span class="w"> </span><span class="n">Now</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">Deadline</span><span class="w"> </span><span class="k">of</span><span class="w">
                </span><span class="ss">true</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
                    </span><span class="nc">timer</span><span class="p">:</span><span class="nf">sleep</span><span class="p" data-group-id="2434132950-20">(</span><span class="mi">1000</span><span class="p" data-group-id="2434132950-20">)</span><span class="p">,</span><span class="w">
                    </span><span class="nf">wait_for_healthy_loop</span><span class="p" data-group-id="2434132950-21">(</span><span class="n">StoreId</span><span class="p">,</span><span class="w"> </span><span class="n">Deadline</span><span class="p" data-group-id="2434132950-21">)</span><span class="p">;</span><span class="w">
                </span><span class="ss">false</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
                    </span><span class="p" data-group-id="2434132950-22">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2434132950-23">{</span><span class="ss">timeout</span><span class="p">,</span><span class="w"> </span><span class="n">Status</span><span class="p" data-group-id="2434132950-23">}</span><span class="p" data-group-id="2434132950-22">}</span><span class="w">
            </span><span class="k">end</span><span class="p">;</span><span class="w">
        </span><span class="p" data-group-id="2434132950-24">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">not_running</span><span class="p" data-group-id="2434132950-24">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="nc">timer</span><span class="p">:</span><span class="nf">sleep</span><span class="p" data-group-id="2434132950-25">(</span><span class="mi">500</span><span class="p" data-group-id="2434132950-25">)</span><span class="p">,</span><span class="w">
            </span><span class="nf">wait_for_healthy_loop</span><span class="p" data-group-id="2434132950-26">(</span><span class="n">StoreId</span><span class="p">,</span><span class="w"> </span><span class="n">Deadline</span><span class="p" data-group-id="2434132950-26">)</span><span class="w">
    </span><span class="k">end</span><span class="p">.</span></code></pre><h3 id="2-load-balancer-integration" class="section-heading"><a href="#2-load-balancer-integration" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">2. Load Balancer Integration</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% Remove unhealthy nodes from load balancer</span><span class="w">
</span><span class="nf">init</span><span class="p" data-group-id="6589240438-1">(</span><span class="p" data-group-id="6589240438-2">[</span><span class="p" data-group-id="6589240438-2">]</span><span class="p" data-group-id="6589240438-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">reckon_db_health_prober</span><span class="p">:</span><span class="nf">on_node_failed</span><span class="p" data-group-id="6589240438-3">(</span><span class="ss">my_store</span><span class="p">,</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="6589240438-4">(</span><span class="n">Node</span><span class="p" data-group-id="6589240438-4">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="nc">haproxy_api</span><span class="p">:</span><span class="nf">disable_server</span><span class="p" data-group-id="6589240438-5">(</span><span class="n">Node</span><span class="p" data-group-id="6589240438-5">)</span><span class="w">
    </span><span class="k">end</span><span class="p" data-group-id="6589240438-3">)</span><span class="p">,</span><span class="w">
    </span><span class="nc">reckon_db_health_prober</span><span class="p">:</span><span class="nf">on_node_recovered</span><span class="p" data-group-id="6589240438-6">(</span><span class="ss">my_store</span><span class="p">,</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="6589240438-7">(</span><span class="n">Node</span><span class="p" data-group-id="6589240438-7">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="nc">haproxy_api</span><span class="p">:</span><span class="nf">enable_server</span><span class="p" data-group-id="6589240438-8">(</span><span class="n">Node</span><span class="p" data-group-id="6589240438-8">)</span><span class="w">
    </span><span class="k">end</span><span class="p" data-group-id="6589240438-6">)</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="6589240438-9">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="o">#</span><span class="ss">state</span><span class="p" data-group-id="6589240438-10">{</span><span class="p" data-group-id="6589240438-10">}</span><span class="p" data-group-id="6589240438-9">}</span><span class="p">.</span></code></pre><h3 id="3-circuit-breaker-pattern" class="section-heading"><a href="#3-circuit-breaker-pattern" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">3. Circuit Breaker Pattern</span></h3><pre><code class="makeup erlang" translate="no"><span class="p">-</span><span class="na">record</span><span class="p" data-group-id="1606518262-1">(</span><span class="ss">state</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1606518262-2">{</span><span class="w">
    </span><span class="ss">circuit</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="ss">closed</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="ss">open</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="ss">half_open</span><span class="p">,</span><span class="w">
    </span><span class="ss">failures</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">non_neg_integer</span><span class="p" data-group-id="1606518262-3">(</span><span class="p" data-group-id="1606518262-3">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">last_attempt</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">integer</span><span class="p" data-group-id="1606518262-4">(</span><span class="p" data-group-id="1606518262-4">)</span><span class="w">
</span><span class="p" data-group-id="1606518262-2">}</span><span class="p" data-group-id="1606518262-1">)</span><span class="p">.</span><span class="w">

</span><span class="nf">handle_call</span><span class="p" data-group-id="1606518262-5">(</span><span class="p" data-group-id="1606518262-6">{</span><span class="ss">append</span><span class="p">,</span><span class="w"> </span><span class="n">Stream</span><span class="p">,</span><span class="w"> </span><span class="n">Events</span><span class="p" data-group-id="1606518262-6">}</span><span class="p">,</span><span class="w"> </span><span class="n">From</span><span class="p">,</span><span class="w"> </span><span class="o">#</span><span class="ss">state</span><span class="p" data-group-id="1606518262-7">{</span><span class="ss">circuit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">open</span><span class="p" data-group-id="1606518262-7">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="1606518262-5">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Check if should try again</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nf">should_retry</span><span class="p" data-group-id="1606518262-8">(</span><span class="n">State</span><span class="p" data-group-id="1606518262-8">)</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="ss">true</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="nf">try_append</span><span class="p" data-group-id="1606518262-9">(</span><span class="n">Stream</span><span class="p">,</span><span class="w"> </span><span class="n">Events</span><span class="p">,</span><span class="w"> </span><span class="n">From</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="o">#</span><span class="ss">state</span><span class="p" data-group-id="1606518262-10">{</span><span class="ss">circuit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">half_open</span><span class="p" data-group-id="1606518262-10">}</span><span class="p" data-group-id="1606518262-9">)</span><span class="p">;</span><span class="w">
        </span><span class="ss">false</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="p" data-group-id="1606518262-11">{</span><span class="ss">reply</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1606518262-12">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">circuit_open</span><span class="p" data-group-id="1606518262-12">}</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="1606518262-11">}</span><span class="w">
    </span><span class="k">end</span><span class="p">;</span><span class="w">

</span><span class="nf">handle_call</span><span class="p" data-group-id="1606518262-13">(</span><span class="p" data-group-id="1606518262-14">{</span><span class="ss">append</span><span class="p">,</span><span class="w"> </span><span class="n">Stream</span><span class="p">,</span><span class="w"> </span><span class="n">Events</span><span class="p" data-group-id="1606518262-14">}</span><span class="p">,</span><span class="w"> </span><span class="n">From</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="1606518262-13">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nf">try_append</span><span class="p" data-group-id="1606518262-15">(</span><span class="n">Stream</span><span class="p">,</span><span class="w"> </span><span class="n">Events</span><span class="p">,</span><span class="w"> </span><span class="n">From</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="1606518262-15">)</span><span class="p">.</span><span class="w">

</span><span class="nf">try_append</span><span class="p" data-group-id="1606518262-16">(</span><span class="n">Stream</span><span class="p">,</span><span class="w"> </span><span class="n">Events</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="n">From</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="1606518262-16">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">reckon_db_consistency_checker</span><span class="p">:</span><span class="nf">get_status</span><span class="p" data-group-id="1606518262-17">(</span><span class="ss">my_store</span><span class="p" data-group-id="1606518262-17">)</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="p" data-group-id="1606518262-18">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="ss">healthy</span><span class="p" data-group-id="1606518262-18">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="n">Result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">reckon_db_streams</span><span class="p">:</span><span class="nf">append</span><span class="p" data-group-id="1606518262-19">(</span><span class="ss">my_store</span><span class="p">,</span><span class="w"> </span><span class="n">Stream</span><span class="p">,</span><span class="w"> </span><span class="ss">any</span><span class="p">,</span><span class="w"> </span><span class="n">Events</span><span class="p" data-group-id="1606518262-19">)</span><span class="p">,</span><span class="w">
            </span><span class="p" data-group-id="1606518262-20">{</span><span class="ss">reply</span><span class="p">,</span><span class="w"> </span><span class="n">Result</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="o">#</span><span class="ss">state</span><span class="p" data-group-id="1606518262-21">{</span><span class="ss">circuit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">closed</span><span class="p">,</span><span class="w"> </span><span class="ss">failures</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="1606518262-21">}</span><span class="p" data-group-id="1606518262-20">}</span><span class="p">;</span><span class="w">
        </span><span class="p" data-group-id="1606518262-22">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Status</span><span class="p" data-group-id="1606518262-22">}</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="n">Status</span><span class="w"> </span><span class="o">=:=</span><span class="w"> </span><span class="ss">split_brain</span><span class="p">;</span><span class="w"> </span><span class="n">Status</span><span class="w"> </span><span class="o">=:=</span><span class="w"> </span><span class="ss">no_quorum</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="n">NewState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">State</span><span class="o">#</span><span class="ss">state</span><span class="p" data-group-id="1606518262-23">{</span><span class="w">
                </span><span class="ss">circuit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">open</span><span class="p">,</span><span class="w">
                </span><span class="ss">failures</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">State</span><span class="o">#</span><span class="ss">state</span><span class="p">.</span><span class="ss">failures</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
                </span><span class="ss">last_attempt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">erlang</span><span class="p">:</span><span class="nf">monotonic_time</span><span class="p" data-group-id="1606518262-24">(</span><span class="ss">millisecond</span><span class="p" data-group-id="1606518262-24">)</span><span class="w">
            </span><span class="p" data-group-id="1606518262-23">}</span><span class="p">,</span><span class="w">
            </span><span class="p" data-group-id="1606518262-25">{</span><span class="ss">reply</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1606518262-26">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1606518262-27">{</span><span class="ss">cluster_unhealthy</span><span class="p">,</span><span class="w"> </span><span class="n">Status</span><span class="p" data-group-id="1606518262-27">}</span><span class="p" data-group-id="1606518262-26">}</span><span class="p">,</span><span class="w"> </span><span class="n">NewState</span><span class="p" data-group-id="1606518262-25">}</span><span class="p">;</span><span class="w">
        </span><span class="p">_</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="p" data-group-id="1606518262-28">{</span><span class="ss">reply</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1606518262-29">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">status_unknown</span><span class="p" data-group-id="1606518262-29">}</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="1606518262-28">}</span><span class="w">
    </span><span class="k">end</span><span class="p">.</span></code></pre><h2 id="telemetry-events" class="section-heading"><a href="#telemetry-events" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Telemetry Events</span></h2><h3 id="consistency-checker-events" class="section-heading"><a href="#consistency-checker-events" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Consistency Checker Events</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% Check completed</span><span class="w">
</span><span class="p" data-group-id="4659862552-1">[</span><span class="ss">reckon_db</span><span class="p">,</span><span class="w"> </span><span class="ss">consistency</span><span class="p">,</span><span class="w"> </span><span class="ss">check</span><span class="p">,</span><span class="w"> </span><span class="ss">complete</span><span class="p" data-group-id="4659862552-1">]</span><span class="w">
</span><span class="c1">%% Measurements: #{duration_us =&gt; integer()}</span><span class="w">
</span><span class="c1">%% Metadata: #{store_id =&gt; atom(), status =&gt; atom(), checks =&gt; map()}</span><span class="w">

</span><span class="c1">%% Status changed</span><span class="w">
</span><span class="p" data-group-id="4659862552-2">[</span><span class="ss">reckon_db</span><span class="p">,</span><span class="w"> </span><span class="ss">consistency</span><span class="p">,</span><span class="w"> </span><span class="ss">status</span><span class="p">,</span><span class="w"> </span><span class="ss">changed</span><span class="p" data-group-id="4659862552-2">]</span><span class="w">
</span><span class="c1">%% Measurements: #{system_time =&gt; integer()}</span><span class="w">
</span><span class="c1">%% Metadata: #{store_id =&gt; atom(), old_status =&gt; atom(), new_status =&gt; atom()}</span><span class="w">

</span><span class="c1">%% Split-brain detected</span><span class="w">
</span><span class="p" data-group-id="4659862552-3">[</span><span class="ss">reckon_db</span><span class="p">,</span><span class="w"> </span><span class="ss">consistency</span><span class="p">,</span><span class="w"> </span><span class="ss">split_brain</span><span class="p">,</span><span class="w"> </span><span class="ss">detected</span><span class="p" data-group-id="4659862552-3">]</span><span class="w">
</span><span class="c1">%% Measurements: #{system_time =&gt; integer()}</span><span class="w">
</span><span class="c1">%% Metadata: #{store_id =&gt; atom(), result =&gt; map()}</span></code></pre><h3 id="health-prober-events" class="section-heading"><a href="#health-prober-events" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Health Prober Events</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% Probe cycle completed</span><span class="w">
</span><span class="p" data-group-id="7105582303-1">[</span><span class="ss">reckon_db</span><span class="p">,</span><span class="w"> </span><span class="ss">health</span><span class="p">,</span><span class="w"> </span><span class="ss">probe</span><span class="p">,</span><span class="w"> </span><span class="ss">complete</span><span class="p" data-group-id="7105582303-1">]</span><span class="w">
</span><span class="c1">%% Measurements: #{duration_us =&gt; integer(), success_count =&gt; integer(), failure_count =&gt; integer()}</span><span class="w">
</span><span class="c1">%% Metadata: #{store_id =&gt; atom()}</span><span class="w">

</span><span class="c1">%% Node declared failed</span><span class="w">
</span><span class="p" data-group-id="7105582303-2">[</span><span class="ss">reckon_db</span><span class="p">,</span><span class="w"> </span><span class="ss">health</span><span class="p">,</span><span class="w"> </span><span class="nb">node</span><span class="p">,</span><span class="w"> </span><span class="ss">failed</span><span class="p" data-group-id="7105582303-2">]</span><span class="w">
</span><span class="c1">%% Measurements: #{system_time =&gt; integer(), consecutive_failures =&gt; integer()}</span><span class="w">
</span><span class="c1">%% Metadata: #{store_id =&gt; atom(), node =&gt; node()}</span><span class="w">

</span><span class="c1">%% Node recovered</span><span class="w">
</span><span class="p" data-group-id="7105582303-3">[</span><span class="ss">reckon_db</span><span class="p">,</span><span class="w"> </span><span class="ss">health</span><span class="p">,</span><span class="w"> </span><span class="nb">node</span><span class="p">,</span><span class="w"> </span><span class="ss">recovered</span><span class="p" data-group-id="7105582303-3">]</span><span class="w">
</span><span class="c1">%% Measurements: #{system_time =&gt; integer()}</span><span class="w">
</span><span class="c1">%% Metadata: #{store_id =&gt; atom(), node =&gt; node()}</span></code></pre><h3 id="example-telemetry-handler" class="section-heading"><a href="#example-telemetry-handler" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Example Telemetry Handler</span></h3><pre><code class="makeup erlang" translate="no"><span class="nf">setup_telemetry</span><span class="p" data-group-id="6410585673-1">(</span><span class="p" data-group-id="6410585673-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">telemetry</span><span class="p">:</span><span class="nf">attach_many</span><span class="p" data-group-id="6410585673-2">(</span><span class="w">
        </span><span class="p" data-group-id="6410585673-3">&lt;&lt;</span><span class="s">&quot;cluster-health-handler&quot;</span><span class="p" data-group-id="6410585673-3">&gt;&gt;</span><span class="p">,</span><span class="w">
        </span><span class="p" data-group-id="6410585673-4">[</span><span class="w">
            </span><span class="p" data-group-id="6410585673-5">[</span><span class="ss">reckon_db</span><span class="p">,</span><span class="w"> </span><span class="ss">consistency</span><span class="p">,</span><span class="w"> </span><span class="ss">split_brain</span><span class="p">,</span><span class="w"> </span><span class="ss">detected</span><span class="p" data-group-id="6410585673-5">]</span><span class="p">,</span><span class="w">
            </span><span class="p" data-group-id="6410585673-6">[</span><span class="ss">reckon_db</span><span class="p">,</span><span class="w"> </span><span class="ss">health</span><span class="p">,</span><span class="w"> </span><span class="nb">node</span><span class="p">,</span><span class="w"> </span><span class="ss">failed</span><span class="p" data-group-id="6410585673-6">]</span><span class="w">
        </span><span class="p" data-group-id="6410585673-4">]</span><span class="p">,</span><span class="w">
        </span><span class="k">fun</span><span class="w"> </span><span class="ss">handle_cluster_event</span><span class="p">/</span><span class="mi">4</span><span class="p">,</span><span class="w">
        </span><span class="p" data-group-id="6410585673-7">#{</span><span class="p" data-group-id="6410585673-7">}</span><span class="w">
    </span><span class="p" data-group-id="6410585673-2">)</span><span class="p">.</span><span class="w">

</span><span class="nf">handle_cluster_event</span><span class="p" data-group-id="6410585673-8">(</span><span class="p" data-group-id="6410585673-9">[</span><span class="ss">reckon_db</span><span class="p">,</span><span class="w"> </span><span class="ss">consistency</span><span class="p">,</span><span class="w"> </span><span class="ss">split_brain</span><span class="p">,</span><span class="w"> </span><span class="ss">detected</span><span class="p" data-group-id="6410585673-9">]</span><span class="p">,</span><span class="w">
                     </span><span class="p">_</span><span class="n">Measurements</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6410585673-10">#{</span><span class="ss">store_id</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">StoreId</span><span class="p" data-group-id="6410585673-10">}</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="n">Config</span><span class="p" data-group-id="6410585673-8">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">pagerduty</span><span class="p">:</span><span class="nf">trigger</span><span class="p" data-group-id="6410585673-11">(</span><span class="p" data-group-id="6410585673-12">#{</span><span class="w">
        </span><span class="ss">severity</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">critical</span><span class="p">,</span><span class="w">
        </span><span class="ss">summary</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nc">io_lib</span><span class="p">:</span><span class="nf">format</span><span class="p" data-group-id="6410585673-13">(</span><span class="s">&quot;Split-brain detected in </span><span class="si">~p</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6410585673-14">[</span><span class="n">StoreId</span><span class="p" data-group-id="6410585673-14">]</span><span class="p" data-group-id="6410585673-13">)</span><span class="w">
    </span><span class="p" data-group-id="6410585673-12">}</span><span class="p" data-group-id="6410585673-11">)</span><span class="p">;</span><span class="w">

</span><span class="nf">handle_cluster_event</span><span class="p" data-group-id="6410585673-15">(</span><span class="p" data-group-id="6410585673-16">[</span><span class="ss">reckon_db</span><span class="p">,</span><span class="w"> </span><span class="ss">health</span><span class="p">,</span><span class="w"> </span><span class="nb">node</span><span class="p">,</span><span class="w"> </span><span class="ss">failed</span><span class="p" data-group-id="6410585673-16">]</span><span class="p">,</span><span class="w">
                     </span><span class="p" data-group-id="6410585673-17">#{</span><span class="ss">consecutive_failures</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Failures</span><span class="p" data-group-id="6410585673-17">}</span><span class="p">,</span><span class="w">
                     </span><span class="p" data-group-id="6410585673-18">#{</span><span class="ss">store_id</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">StoreId</span><span class="p">,</span><span class="w"> </span><span class="nb">node</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Node</span><span class="p" data-group-id="6410585673-18">}</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="n">Config</span><span class="p" data-group-id="6410585673-15">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">prometheus_counter</span><span class="p">:</span><span class="nf">inc</span><span class="p" data-group-id="6410585673-19">(</span><span class="ss">node_failures_total</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6410585673-20">[</span><span class="n">StoreId</span><span class="p">,</span><span class="w"> </span><span class="n">Node</span><span class="p" data-group-id="6410585673-20">]</span><span class="p" data-group-id="6410585673-19">)</span><span class="p">,</span><span class="w">
    </span><span class="nc">slack</span><span class="p">:</span><span class="nf">post</span><span class="p" data-group-id="6410585673-21">(</span><span class="ss">ops_channel</span><span class="p">,</span><span class="w">
               </span><span class="nc">io_lib</span><span class="p">:</span><span class="nf">format</span><span class="p" data-group-id="6410585673-22">(</span><span class="s">&quot;Node </span><span class="si">~p</span><span class="s"> failed after </span><span class="si">~p</span><span class="s"> probes&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6410585673-23">[</span><span class="n">Node</span><span class="p">,</span><span class="w"> </span><span class="n">Failures</span><span class="p" data-group-id="6410585673-23">]</span><span class="p" data-group-id="6410585673-22">)</span><span class="p" data-group-id="6410585673-21">)</span><span class="p">.</span></code></pre><h2 id="troubleshooting" class="section-heading"><a href="#troubleshooting" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Troubleshooting</span></h2><h3 id="common-issues" class="section-heading"><a href="#common-issues" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Common Issues</span></h3><table><thead><tr><th style="text-align: left;">Symptom</th><th style="text-align: left;">Likely Cause</th><th style="text-align: left;">Resolution</th></tr></thead><tbody><tr><td style="text-align: left;">Frequent <code class="inline">degraded</code> status</td><td style="text-align: left;">Network latency</td><td style="text-align: left;">Increase probe timeout</td></tr><tr><td style="text-align: left;"><code class="inline">no_quorum</code> after restart</td><td style="text-align: left;">Nodes not discovered</td><td style="text-align: left;">Check UDP multicast</td></tr><tr><td style="text-align: left;"><code class="inline">split_brain</code> detected</td><td style="text-align: left;">Network partition</td><td style="text-align: left;">Identify partition, restore connectivity</td></tr><tr><td style="text-align: left;">Slow recovery detection</td><td style="text-align: left;">High failure threshold</td><td style="text-align: left;">Reduce threshold (with caution)</td></tr></tbody></table><h3 id="diagnostic-commands" class="section-heading"><a href="#diagnostic-commands" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Diagnostic Commands</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% Full cluster status</span><span class="w">
</span><span class="p" data-group-id="6433395198-1">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Result</span><span class="p" data-group-id="6433395198-1">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">reckon_db_consistency_checker</span><span class="p">:</span><span class="nf">check_now</span><span class="p" data-group-id="6433395198-2">(</span><span class="ss">my_store</span><span class="p" data-group-id="6433395198-2">)</span><span class="p">.</span><span class="w">
</span><span class="nc">io</span><span class="p">:</span><span class="nf">format</span><span class="p" data-group-id="6433395198-3">(</span><span class="s">&quot;Status: </span><span class="si">~p</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6433395198-4">[</span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="6433395198-5">(</span><span class="ss">status</span><span class="p">,</span><span class="w"> </span><span class="n">Result</span><span class="p" data-group-id="6433395198-5">)</span><span class="p" data-group-id="6433395198-4">]</span><span class="p" data-group-id="6433395198-3">)</span><span class="p">.</span><span class="w">
</span><span class="nc">io</span><span class="p">:</span><span class="nf">format</span><span class="p" data-group-id="6433395198-6">(</span><span class="s">&quot;Checks: </span><span class="si">~p</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6433395198-7">[</span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="6433395198-8">(</span><span class="ss">checks</span><span class="p">,</span><span class="w"> </span><span class="n">Result</span><span class="p" data-group-id="6433395198-8">)</span><span class="p" data-group-id="6433395198-7">]</span><span class="p" data-group-id="6433395198-6">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Node health details</span><span class="w">
</span><span class="n">AllStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">reckon_db_health_prober</span><span class="p">:</span><span class="nf">get_all_status</span><span class="p" data-group-id="6433395198-9">(</span><span class="ss">my_store</span><span class="p" data-group-id="6433395198-9">)</span><span class="p">.</span><span class="w">
</span><span class="nc">maps</span><span class="p">:</span><span class="nf">foreach</span><span class="p" data-group-id="6433395198-10">(</span><span class="nf">fun</span><span class="p" data-group-id="6433395198-11">(</span><span class="n">Node</span><span class="p">,</span><span class="w"> </span><span class="n">Status</span><span class="p" data-group-id="6433395198-11">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">io</span><span class="p">:</span><span class="nf">format</span><span class="p" data-group-id="6433395198-12">(</span><span class="s">&quot;  </span><span class="si">~p</span><span class="s">: </span><span class="si">~p</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6433395198-13">[</span><span class="n">Node</span><span class="p">,</span><span class="w"> </span><span class="n">Status</span><span class="p" data-group-id="6433395198-13">]</span><span class="p" data-group-id="6433395198-12">)</span><span class="w">
</span><span class="k">end</span><span class="p">,</span><span class="w"> </span><span class="n">AllStatus</span><span class="p" data-group-id="6433395198-10">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Quorum margin</span><span class="w">
</span><span class="p" data-group-id="6433395198-14">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Quorum</span><span class="p" data-group-id="6433395198-14">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">reckon_db_consistency_checker</span><span class="p">:</span><span class="nf">get_quorum_status</span><span class="p" data-group-id="6433395198-15">(</span><span class="ss">my_store</span><span class="p" data-group-id="6433395198-15">)</span><span class="p">.</span><span class="w">
</span><span class="nc">io</span><span class="p">:</span><span class="nf">format</span><span class="p" data-group-id="6433395198-16">(</span><span class="s">&quot;Can lose </span><span class="si">~p</span><span class="s"> more nodes</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6433395198-17">[</span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="6433395198-18">(</span><span class="ss">can_lose</span><span class="p">,</span><span class="w"> </span><span class="n">Quorum</span><span class="p" data-group-id="6433395198-18">)</span><span class="p" data-group-id="6433395198-17">]</span><span class="p" data-group-id="6433395198-16">)</span><span class="p">.</span></code></pre><h3 id="recovery-procedures" class="section-heading"><a href="#recovery-procedures" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Recovery Procedures</span></h3><h4>Split-Brain Recovery</h4><ol><li><strong>Identify partitioned nodes</strong> - Check which nodes are in each partition</li><li><strong>Stop minority partition</strong> - Gracefully stop nodes in smaller partition</li><li><strong>Restore connectivity</strong> - Fix network issues</li><li><strong>Restart stopped nodes</strong> - They will rejoin and sync from majority</li><li><strong>Verify consistency</strong> - Check events weren't lost</li></ol><pre><code class="makeup erlang" translate="no"><span class="c1">%% After recovery, force verification</span><span class="w">
</span><span class="n">Result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">reckon_db_consistency_checker</span><span class="p">:</span><span class="nf">check_now</span><span class="p" data-group-id="7367410659-1">(</span><span class="ss">my_store</span><span class="p" data-group-id="7367410659-1">)</span><span class="p">,</span><span class="w">
</span><span class="k">case</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="7367410659-2">(</span><span class="ss">status</span><span class="p">,</span><span class="w"> </span><span class="n">Result</span><span class="p" data-group-id="7367410659-2">)</span><span class="w"> </span><span class="k">of</span><span class="w">
    </span><span class="ss">healthy</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">logger</span><span class="p">:</span><span class="nf">info</span><span class="p" data-group-id="7367410659-3">(</span><span class="s">&quot;Recovery successful&quot;</span><span class="p" data-group-id="7367410659-3">)</span><span class="p">;</span><span class="w">
    </span><span class="n">Other</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">logger</span><span class="p">:</span><span class="nf">error</span><span class="p" data-group-id="7367410659-4">(</span><span class="s">&quot;Still unhealthy: </span><span class="si">~p</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7367410659-5">[</span><span class="n">Other</span><span class="p" data-group-id="7367410659-5">]</span><span class="p" data-group-id="7367410659-4">)</span><span class="w">
</span><span class="k">end</span><span class="p">.</span></code></pre><h2 id="configuration-reference" class="section-heading"><a href="#configuration-reference" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Configuration Reference</span></h2><h3 id="consistency-checker-1" class="section-heading"><a href="#consistency-checker-1" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Consistency Checker</span></h3><table><thead><tr><th style="text-align: left;">Setting</th><th style="text-align: left;">Default</th><th style="text-align: left;">Description</th></tr></thead><tbody><tr><td style="text-align: left;"><code class="inline">consistency_check_interval</code></td><td style="text-align: left;">5000</td><td style="text-align: left;">Milliseconds between checks</td></tr><tr><td style="text-align: left;">(minimum enforced)</td><td style="text-align: left;">1000</td><td style="text-align: left;">Minimum allowed interval</td></tr></tbody></table><h3 id="health-prober" class="section-heading"><a href="#health-prober" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Health Prober</span></h3><table><thead><tr><th style="text-align: left;">Setting</th><th style="text-align: left;">Default</th><th style="text-align: left;">Description</th></tr></thead><tbody><tr><td style="text-align: left;"><code class="inline">health_probe_interval</code></td><td style="text-align: left;">2000</td><td style="text-align: left;">Milliseconds between probe cycles</td></tr><tr><td style="text-align: left;"><code class="inline">health_probe_timeout</code></td><td style="text-align: left;">1000</td><td style="text-align: left;">Timeout for each probe (ms)</td></tr><tr><td style="text-align: left;"><code class="inline">health_failure_threshold</code></td><td style="text-align: left;">3</td><td style="text-align: left;">Consecutive failures before <code class="inline">failed</code></td></tr><tr><td style="text-align: left;"><code class="inline">health_probe_type</code></td><td style="text-align: left;"><code class="inline">rpc</code></td><td style="text-align: left;">Probe type: <code class="inline">ping</code>, <code class="inline">rpc</code>, or <code class="inline">khepri</code></td></tr></tbody></table><h2 id="academic-references" class="section-heading"><a href="#academic-references" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Academic References</span></h2><ul><li>Ongaro, D. and Ousterhout, J. (2014). <em>In Search of an Understandable Consensus Algorithm (Raft)</em>. USENIX ATC 2014.</li><li>Brewer, E. (2012). <em>CAP Twelve Years Later: How the &quot;Rules&quot; Have Changed</em>. IEEE Computer, 45(2), 23-29.</li><li>Kleppmann, M. (2017). <em>Designing Data-Intensive Applications</em>. O'Reilly Media. Chapter 9: Consistency and Consensus.</li></ul><h2 id="see-also" class="section-heading"><a href="#see-also" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">See Also</span></h2><ul><li><a href="storage_internals.html">Storage Internals</a> - Khepri/Ra replication details</li><li><a href="memory_pressure.html">Memory Pressure</a> - Resource management</li><li><a href="subscriptions.html">Subscriptions</a> - Event delivery in clusters</li></ul>

</div>

<div class="bottom-actions" id="bottom-actions">
  <div class="bottom-actions-item">

      <a href="storage_internals.html" class="bottom-actions-button" rel="prev">
        <span class="subheader">
          â† Previous Page
        </span>
        <span class="title">
Storage Internals
        </span>
      </a>

  </div>
  <div class="bottom-actions-item">

  </div>
</div>
    <footer class="footer">
      <p>

          <span class="line">
            <a href="https://hex.pm/packages/reckon_db/1.2.0" class="footer-hex-package">Hex Package</a>

            <a href="https://preview.hex.pm/preview/reckon_db/1.2.0">Hex Preview</a>

              (<a href="https://preview.hex.pm/preview/reckon_db/1.2.0/show/guides/cluster_consistency.md">current file</a>)

          </span>

        <span class="line">
          <button class="a-main footer-button display-quick-switch" title="Search HexDocs packages">
            Search HexDocs
          </button>

            <a href="reckon_db.epub" title="ePub version">
              Download ePub version
            </a>

        </span>
      </p>

      <p class="built-using">
        Built using
        <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.38.2) for the

          <a href="https://erlang.org" title="Erlang" target="_blank" translate="no">Erlang programming language</a>

      </p>

    </footer>
  </div>
</main>
</div>

  </body>
</html>
